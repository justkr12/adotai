import os
import sys
import shutil

# --- 1. ìœ ì € ì…ë ¥ ë°›ê¸° ---
def get_user_inputs():
    print("--- opendiscordbot í”„ë¡œì íŠ¸ ìƒì„±ê¸° ---")
    print("ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Discord ë´‡ì˜ ë‹¤ì–‘í•œ ë²„ì „ì„ ìƒì„±í•©ë‹ˆë‹¤.")
    print("ìƒì„±ëœ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•˜ì—¬ '.env' íŒŒì¼ì„ ì—´ì–´ YOUR_...HERE ë¡œ ëœ ë¶€ë¶„ë“¤ì„ ë°˜ë“œì‹œ ì±„ì›Œì£¼ì„¸ìš”.")

    bot_name = input("1. ë´‡ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ê°’: opendiscordbot): ").strip() or "opendiscordbot"
    currency_name = input(f"2. {bot_name}ì—ì„œ ì‚¬ìš©í•  í™”í ë‹¨ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ê°’: ìœ„í‚¤ì›): ").strip() or "ìœ„í‚¤ì›"

    print("\n--- 3. ìƒì„±í•  ë´‡ì˜ ëŸ°íƒ€ì„ ì¢…ë¥˜ ì„ íƒ ---")
    print("1. Python Botë§Œ ìƒì„±")
    print("2. Node.js Botë§Œ ìƒì„±")
    print("3. Python Botê³¼ Node.js Bot ëª¨ë‘ ìƒì„±")
    bot_runtime_choice = input("ì„ íƒ (1/2/3): ").strip()

    try:
        bot_runtime_choice = int(bot_runtime_choice)
        if bot_runtime_choice not in [1, 2, 3]:
            raise ValueError
    except ValueError:
        print("âŒ ì˜ëª»ëœ ëŸ°íƒ€ì„ ì„ íƒì…ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        sys.exit(1)

    print("\n--- 4. ìƒì„±í•  í”„ë¡œì íŠ¸ ë²„ì „ ì„ íƒ ---")
    print("1. Version 1: [ì›ë³¸] ì›¹ ëŒ€ì‹œë³´ë“œ O (Flask), Anvil API O (ì´ë©”ì¼ ë´‡, API ì„œë²„), í™ˆí˜ì´ì§€, ìë™íšŒì‹  ì‹œìŠ¤í…œ")
    print("2. Version 2: [ëŒ€ì‹œë³´ë“œ X] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, Anvil API O (ì´ë©”ì¼ ë´‡, API ì„œë²„), ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    print("3. Version 3: [Anvil API X] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, Flask API (Wispbyte/SQLite), ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    print("4. Version 4: [ìˆœìˆ˜ ë´‡] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, API ì—†ìŒ, ë¡œì»¬ SQLite DB, í•œ ê¸¸ë“œ ì „ìš©, ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    version_choice = input("ë²„ì „ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1/2/3/4): ").strip()

    try:
        version_choice = int(version_choice)
        if version_choice not in [1, 2, 3, 4]:
            raise ValueError
    except ValueError:
        print("âŒ ì˜ëª»ëœ ë²„ì „ ì„ íƒì…ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        sys.exit(1)
    
    # ğŸš© íŒŒì´ì¬ ë²„ì „ë³„ API/ì´ë©”ì¼ ë´‡/ëŒ€ì‹œë³´ë“œ í™œì„±í™” í”Œë˜ê·¸
    is_dashboard_enabled = (version_choice == 1)
    is_flask_api_enabled = (version_choice == 1 or version_choice == 2 or version_choice == 3) # V1, V2ëŠ” Anvil API, V3ëŠ” Flask API (ì—¬ê¸°ì„œ ë¹Œë“œ)
    is_email_bot_enabled = (version_choice == 1)
    is_pure_bot_mode = (version_choice == 4)

    return bot_name, currency_name, bot_runtime_choice, version_choice, is_dashboard_enabled, is_flask_api_enabled, is_email_bot_enabled, is_pure_bot_mode

# --- 2.0. .env íŒŒì¼ í…œí”Œë¦¿ ---
def get_env_content(bot_name, currency_name, is_dashboard_enabled, is_flask_api_enabled, is_email_bot_enabled, is_pure_bot_mode):
    env_content = f"""
# .env íŒŒì¼ - {bot_name} í”„ë¡œì íŠ¸ í™˜ê²½ ì„¤ì •

# ë´‡ í† í° (í•„ìˆ˜)
BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN_HERE"

# --- ì›¹ ëŒ€ì‹œë³´ë“œ ê´€ë¦¬ì ê³„ì • (V1ë§Œ ì‚¬ìš©) ---
{"DASHBOARD_ADMIN_USERNAME='sejungim39'" if is_dashboard_enabled else "# DASHBOARD_ADMIN_USERNAME='sejungim39'"}
{"DASHBOARD_ADMIN_PASSWORD='Ty822pzh9kd5uSeC'" if is_dashboard_enabled else "# DASHBOARD_ADMIN_PASSWORD='Ty822pzh9kd5uSeC'"}

# --- API ì„œë²„ URL ì„¤ì • (V1, V2, V3ë§Œ ì‚¬ìš©) ---
# ğŸš© ì¤‘ìš”: ë²„ì „ë³„ë¡œ ì´ ê°’ì˜ ì—­í• ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤!
# V1, V2 (Anvil API): Anvil ì•±ì„ ì›¹ì— ë°œí–‰(Publish)í•œ í›„, App Accessì˜ "HTTPS API endpoint URL" (ì˜ˆ: https://your-app-name.anvil.app/_/api/)
# V3 (Flask API): Wispbyteê°€ í• ë‹¹í•œ Flask API ì£¼ì†Œ (ì˜ˆ: http://luna.wisp.uno:8080)
# V4 (API ì—†ìŒ): ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (FLASK_BACKEND_URL=""ë¡œ ë¹„ì›Œë‘ì„¸ìš”)
{"FLASK_BACKEND_URL='YOUR_API_SERVER_URL_HERE'" if is_flask_api_enabled else "FLASK_BACKEND_URL=''"}

# ğŸš© ì¤‘ìš”: ë´‡ì´ Flask/Anvil APIë¡œ ë°ì´í„° ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” API í‚¤
{"BOT_API_KEY='YOUR_SUPER_SECRET_BOT_API_KEY_HERE'" if is_flask_api_enabled else "BOT_API_KEY=''"}

# ğŸš© ì›¹ ëŒ€ì‹œë³´ë“œ JWT ë°œê¸‰/ê²€ì¦ìš© ì‹œí¬ë¦¿ í‚¤ (V1ë§Œ ì‚¬ìš©)
{"SECRET_KEY='YOUR_JWT_SECRET_KEY_HERE'" if is_dashboard_enabled else "# SECRET_KEY='YOUR_JWT_SECRET_KEY_HERE'"}

# --- Discord OAuth2 ì„¤ì • (V1ë§Œ ì‚¬ìš©) ---
{"DISCORD_CLIENT_ID='YOUR_DISCORD_CLIENT_ID_HERE'" if is_dashboard_enabled else "# DISCORD_CLIENT_ID='YOUR_DISCORD_CLIENT_ID_HERE'"}
{"DISCORD_CLIENT_SECRET='YOUR_DISCORD_CLIENT_SECRET_HERE'" if is_dashboard_enabled else "# DISCORD_CLIENT_SECRET='YOUR_DISCORD_CLIENT_SECRET_HERE'"}

# --- MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (í˜„ì¬ ì´ ë²„ì „ë“¤ì€ SQLiteë¥¼ ë©”ì¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë©° MySQLì€ í•„ìš”í•˜ì§€ ì•ŠìŒ) ---
# MySQLì„ ì‚¬ìš©í•˜ê³ ì í•  ê²½ìš° ê´€ë ¨ Flask API (V3) ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
# # MYSQL_HOST="YOUR_MYSQL_HOST_HERE"
# # MYSQL_USER="YOUR_MYSQL_USERNAME_HERE"
# # MYSQL_PASSWORD="YOUR_MYSQL_PASSWORD_HERE"
# # MYSQL_DB="YOUR_MYSQL_DATABASE_NAME_HERE"

# --- {BOT_NAME} ì´ë©”ì¼ ì§€ì› ì‹œìŠ¤í…œ ì„¤ì • (V1ë§Œ ì‚¬ìš©) ---
{"SUPPORT_EMAIL_ADDRESS='support@your_domain.com'" if is_email_bot_enabled else "# SUPPORT_EMAIL_ADDRESS='support@your_domain.com'"}
{"SUPPORT_EMAIL_PASSWORD='your_email_app_password'" if is_email_bot_enabled else "# SUPPORT_EMAIL_PASSWORD='your_email_app_password'"}

{"IMAP_SERVER='imap.gmail.com'" if is_email_bot_enabled else "# IMAP_SERVER='imap.gmail.com'"}
{"IMAP_PORT=993" if is_email_bot_enabled else "# IMAP_PORT=993"}
{"SMTP_SERVER='smtp.gmail.com'" if is_email_bot_enabled else "# SMTP_SERVER='smtp.gmail.com'"}
{"SMTP_PORT=587" if is_email_bot_enabled else "# SMTP_PORT=587"}

# --- YouTube Data API v3 ì„¤ì • (V1, V2, V3ë§Œ ì‚¬ìš©) ---
{"YOUTUBE_API_KEY='YOUR_YOUTUBE_API_KEY_HERE'" if is_flask_api_enabled else "YOUTUBE_API_KEY=''"}

# --- ë´‡ ì†Œìœ ì ID (íŠ¹ì • ëª…ë ¹ì–´ ì‚¬ìš© ê¶Œí•œ ë¶€ì—¬ìš©) ---
# ğŸš© ì´ IDë¥¼ í†µí•´ 'ë´‡ ì†Œìœ ì ì „ìš©' ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
BOT_OWNER_ID="YOUR_BOT_OWNER_DISCORD_USER_ID_HERE"

# --- V4 (ìˆœìˆ˜ ë´‡) ì „ìš© ì„¤ì • ---
# V4 ì„ íƒ ì‹œ, ë´‡ì„ íŠ¹ì • ê¸¸ë“œì—ë§Œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ ë™ê¸°í™”í•  ê²½ìš° í•´ë‹¹ ê¸¸ë“œ ID (ì •ìˆ˜í˜•)
TARGET_GUILD_ID=0 # ì˜ˆ: 123456789012345678 (ì •ìˆ˜í˜•)

# --- ğŸš© ë‚´ë¶€ í”Œë˜ê·¸ (ìë™ ìƒì„± - ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€) ---
IS_PURE_BOT_MODE={str(is_pure_bot_mode).lower()}
IS_FLASK_API_ENABLED={str(is_flask_api_enabled).lower()}
IS_EMAIL_BOT_ENABLED={str(is_email_bot_enabled).lower()}
IS_DASHBOARD_ENABLED={str(is_dashboard_enabled).lower()}
"""
    return env_content

# 5.2. requirements.txt (íŒŒì´ì¬ ë´‡ìš©)
def get_python_requirements_content(is_flask_api_enabled):
    requirements_content = f"""
discord.py==2.3.2
python-dotenv==1.0.1
PyNaCl==1.5.0
requests==2.32.3
yt-dlp==2025.6.30
google-api-python-client==2.133.0
python-dateutil==2.8.2

# ğŸš© API ì„œë²„ ì‚¬ìš© ì‹œ (V1, V2, V3) í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
"""
    if is_flask_api_enabled: # Flask APIê°€ í™œì„±í™”ëœ ë²„ì „ì—ì„œë§Œ í•„ìš”
        requirements_content += """
Flask==3.1.1
PyJWT==2.8.0
Flask-CORS==4.0.1
mysql-connector-python==8.4.0 # SQLite ëŒ€ì‹  MySQL ì‚¬ìš©í•  ê²½ìš° í•„ìš”
"""
    return requirements_content

# 5.3. JUSTBOT.py (íŒŒì´ì¬ ë´‡ìš© ëŸ°ì²˜ ìŠ¤í¬ë¦½íŠ¸)
def get_justbot_py_content(bot_name):
    return f"""
import subprocess
import time
import os
import sys
from dotenv import load_dotenv

load_dotenv()

# --- ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€) ---
DISCORD_BOT_SCRIPT = "bot.py"
# ğŸš© Flask API ì„œë²„ëŠ” V3ì—ì„œë§Œ ì´ í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
FLASK_API_MODULE_PATH = "justbot_api.app" # ğŸš© Flask API ëª¨ë“ˆ ê²½ë¡œ
EMAIL_SUPPORT_SCRIPT = "email_support_bot.py" # ğŸš© ì´ë©”ì¼ ë´‡ ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ


# --- ë¡œê·¸ íŒŒì¼ ìƒì„± í´ë” ---
LOG_DIR = "logs"
if not os.path.exists(LOG_DIR):
    os.makedirs(LOG_DIR)

def start_background_process(name, script_path_or_module_name, python_executable="python3.11", is_module=False):
    """
    Python ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” ëª¨ë“ˆì„ ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹œì‘í•˜ê³ 
    í‘œì¤€ ì¶œë ¥/ì—ëŸ¬ë¥¼ ì§€ì •ëœ ë¡œê·¸ íŒŒì¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.
    """
    stdout_log_path = os.path.join(LOG_DIR, f"{{name}}_stdout.log")
    stderr_log_path = os.path.join(LOG_DIR, f"{{name}}_stderr.log")

    cmd = []
    if is_module:
        cmd = [python_executable, "-m", script_path_or_module_name]
    else:
        cmd = [python_executable, script_path_or_module_name]

    try:
        process = subprocess.Popen(
            cmd,
            stdout=open(stdout_log_path, "a", buffering=1),
            stderr=open(stderr_log_path, "a", buffering=1),
            text=True,
            bufsize=1,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )
        print(f"ğŸš€ {{name}} ì‹œì‘ ìš”ì²­: PID={{process.pid}}. ë¡œê·¸: {{stdout_log_path}}, {{stderr_log_path}}")
        return process
    except FileNotFoundError:
        print(f"âŒ ì˜¤ë¥˜: '{{python_executable}}' ë˜ëŠ” '{{script_path_or_module_name}}'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None
    except Exception as e:
        print(f"âŒ {{name}} ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {{e}}")
        return None

if __name__ == '__main__':
    print(f"--- {BOT_NAME} í†µí•© ì„œë¹„ìŠ¤ ì‹¤í–‰ê¸° ì‹œì‘ ---")
    print("âš ï¸ ë´‡, API ì„œë²„, ì´ë©”ì¼ ë´‡ ë“± í•„ìš”í•œ ì„œë¹„ìŠ¤ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ìì„¸í•œ ë¡œê·¸ëŠ” 'logs/' ë””ë ‰í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.")

    running_processes = {}

    # 1. ë””ìŠ¤ì½”ë“œ ë´‡ ì‹œì‘ (ëª¨ë“  ë²„ì „ì— í•„ìˆ˜)
    discord_bot_process = start_background_process("Discord_Bot", DISCORD_BOT_SCRIPT, is_module=False)
    if discord_bot_process:
        running_processes["Discord_Bot"] = discord_bot_process

    # 2. Flask API ì„œë²„ ì‹œì‘ (V3ì—ì„œë§Œ ì´ í™˜ê²½ì—ì„œ ì‹¤í–‰)
    if os.getenv("IS_FLASK_API_ENABLED") == "true":
        flask_api_process = start_background_process("Flask_API", FLASK_API_MODULE_PATH, is_module=True)
        if flask_api_process:
            running_processes["Flask_API"] = flask_api_process

    # 3. ì´ë©”ì¼ ì§€ì› ë´‡ ì‹œì‘ (V1ë§Œ)
    if os.getenv("IS_EMAIL_BOT_ENABLED") == "true":
        email_bot_process = start_background_process("Email_Support_Bot", EMAIL_SUPPORT_SCRIPT, is_module=False)
        if email_bot_process:
            running_processes["Email_Support_Bot"] = email_bot_process


    if not running_processes:
        print("âŒ ì‹¤í–‰í•  ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ.")
        sys.exit(1)

    print(f"\n--- {BOT_NAME} í†µí•© ì„œë¹„ìŠ¤ ì‹œì‘ ìš”ì²­ ì™„ë£Œ ---")
    print("ì´ì œ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ì‹¤í–‰ê¸° í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤.")
    print("Ctrl+Cë¥¼ ëˆŒëŸ¬ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    try:
        while True:
            for name, proc in list(running_processes.items()):
                if proc.poll() is not None:
                    print(f"ğŸš¨ {{name}} (PID={{proc.pid}})ê°€ ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¢…ë£Œ ì½”ë“œ: {{proc.poll()}}")
                    running_processes.pop(name)

            if not running_processes:
                print("âš ï¸ ê´€ë¦¬ ì¤‘ì¸ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤í–‰ê¸°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                break

            time.sleep(10)

    except KeyboardInterrupt:
        print("\\nCtrl+C ê°ì§€. ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"âŒ ì‹¤í–‰ê¸° ë©”ì¸ ë£¨í”„ì—ì„œ ì˜ˆì™¸ ë°œìƒ: {{e}}")
    finally:
        print("ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘...")
        for name, proc in running_processes.items():
            if proc.poll() is None:
                proc.terminate()
                try:
                    proc.wait(timeout=5)
                    print(f"âœ… {{name}} ì¢…ë£Œ ì™„ë£Œ.")
                except subprocess.TimeoutExpired:
                    proc.kill()
                    print(f"ğŸš¨ {{name}} ê°•ì œ ì¢…ë£Œ (SIGKILL).")
        print(f"ëª¨ë“  {BOT_NAME} ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
"""

# 2.4. bot.py (Discord ë´‡ ì½”ì–´)
def get_bot_py_content(bot_name, currency_name):
    return f"""
import discord
from discord.ext import commands, tasks
import os
from dotenv import load_dotenv
import sqlite3
import datetime
import requests # HTTP ìš”ì²­ìš© (APIì™€ í†µì‹ )

from googleapiclient.discovery import build # Youtube API client (V1, V2, V3 ì‚¬ìš©)

from discord import app_commands

load_dotenv()

# --- SQLite ì„¤ì • (ë´‡ ìì²´ ë°ì´í„° ë° ì„¤ì • ê´€ë¦¬) ---
# ğŸš© ëª¨ë“  ë²„ì „ ê³µìš© DB
DB_FILE = "rp_server_data.db"

def get_db_connection():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ëª¨ë“  ë´‡ì˜ í…Œì´ë¸” ìƒì„±)
def initialize_db():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # ê³µí†µ í…Œì´ë¸”: ë´‡ ìƒíƒœ
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bot_status (
            bot_name TEXT PRIMARY KEY,
            last_heartbeat TEXT NOT NULL,
            status TEXT NOT NULL,
            message TEXT NOT NULL,
            guild_count INTEGER NOT NULL
        )
    \"\"\")
    # ê³µí†µ í…Œì´ë¸”: ì„œë²„ë³„ ì„¤ì •
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS server_configs (
            guild_id TEXT PRIMARY KEY,
            guild_name TEXT,
            welcome_message_enabled INTEGER DEFAULT 0,
            welcome_message_text TEXT,
            leave_message_enabled INTEGER DEFAULT 0,
            leave_message_text TEXT,
            log_channel_id TEXT,

            car_registration_tax INTEGER DEFAULT 50000,
            car_forbidden_cars_json TEXT DEFAULT '[\"íƒ±í¬\", \"ì „íˆ¬ê¸°\", \"í•µì ìˆ˜í•¨\", \"ìš°ì£¼ì„ \"]',
            registration_channel_id TEXT,
            car_admin_channel_id TEXT,
            car_admin_role_id TEXT,
            approved_cars_channel_id TEXT,

            bank_loan_enabled INTEGER DEFAULT 1,
            bank_max_loan_amount INTEGER DEFAULT 1000000,
            bank_loan_interest_rate REAL DEFAULT 0.032,
            bank_channel_id TEXT,

            auto_kick_warn_count INTEGER DEFAULT 5,
            mute_role_id TEXT,

            ticket_open_channel_id TEXT,
            ticket_category_id TEXT,
            ticket_staff_role_id TEXT,

            invite_filter_enabled INTEGER DEFAULT 0,
            spam_filter_enabled INTEGER DEFAULT 0,
            spam_threshold INTEGER DEFAULT 5,
            spam_time_window INTEGER DEFAULT 10,

            youtube_activity_enabled INTEGER DEFAULT 0,
            youtube_channel_ids_json TEXT DEFAULT '[]',
            youtube_notification_channel_id TEXT
        )
    \"\"\")
    # ì»¬ëŸ¼ ì¶”ê°€ (try-exceptë¡œ ë³€ê²½)
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN guild_name TEXT")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN invite_filter_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_filter_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_threshold INTEGER DEFAULT 5")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_time_window INTEGER DEFAULT 10")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN bank_channel_id TEXT")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_activity_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_channel_ids_json TEXT DEFAULT '[]'")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_notification_channel_id TEXT")
    except sqlite3.OperationalError: pass

    # ìƒˆë¡œìš´ ê³µí†µ í…Œì´ë¸”: ì„œë²„ë³„ ì»¤ë§¨ë“œ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœ
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS server_command_states (
            guild_id TEXT NOT NULL,
            command_name TEXT NOT NULL,
            is_enabled INTEGER NOT NULL DEFAULT 1,
            PRIMARY KEY (guild_id, command_name)
        )
    \"\"\")
    # ìƒˆë¡œìš´ ê³µí†µ í…Œì´ë¸”: ë´‡ í˜„ì¬ ìƒíƒœ ë° í™œë™ (ë´‡ ì†Œìœ ììš©)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bot_presence_settings (
            id INTEGER PRIMARY KEY DEFAULT 1,
            status TEXT DEFAULT 'online',
            activity_type TEXT DEFAULT 'playing',
            activity_name TEXT DEFAULT 'RP ì„œë²„ ìš´ì˜'
        )
    \"\"\")
    cursor.execute("INSERT OR IGNORE INTO bot_presence_settings (id, status, activity_type, activity_name) VALUES (1, 'online', 'playing', 'RP ì„œë²„ ìš´ì˜')")

    # ì€í–‰ ê³„ì¢Œ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bank_accounts (
            user_id TEXT PRIMARY KEY,
            username TEXT NOT NULL,
            balance INTEGER NOT NULL DEFAULT 0
        )
    \"\"\")
    # ì€í–‰ ê±°ë˜ ë‚´ì—­ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bank_transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            type TEXT NOT NULL,
            amount INTEGER NOT NULL,
            timestamp TEXT NOT NULL,
            related_user_id TEXT,
            related_username TEXT,
            description TEXT
        )
    \"\"\")
    # ì°¨ëŸ‰ ë“±ë¡ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS car_registrations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            car_name TEXT NOT NULL,
            registration_tax INTEGER NOT NULL,
            status TEXT NOT NULL,
            requested_at TEXT NOT NULL,
            guild_id TEXT,
            channel_id TEXT,
            approved_by TEXT,
            approved_at TEXT,
            rejected_by TEXT,
            rejected_at TEXT,
            rejection_reason TEXT,
            timed_out_at TEXT
        )
    \"\"\")
    # ì‚¬ìš©ì ê²½ê³  í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS user_warnings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            reason TEXT NOT NULL,
            moderator_id TEXT NOT NULL,
            moderator_name TEXT NOT NULL,
            timestamp TEXT NOT NULL
        )
    \"\"\")
    # ê²Œì„ í†µê³„ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS game_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_type TEXT NOT NULL,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            sides INTEGER,
            result TEXT,
            user_choice TEXT,
            bot_choice TEXT,
            timestamp TEXT NOT NULL
        )
    \"\"\")
    # í‹°ì¼“ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS tickets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            guild_id TEXT NOT NULL,
            channel_id TEXT NOT NULL,
            status TEXT NOT NULL,
            reason TEXT,
            opened_at TEXT NOT NULL,
            closed_at TEXT,
            closed_by TEXT
        )
    \"\"\")
    # ëŒ€ì¶œ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS loans (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            loan_amount INTEGER NOT NULL,
            interest_rate REAL NOT NULL,
            total_repay_amount INTEGER NOT NULL,
            paid_amount INTEGER NOT NULL DEFAULT 0,
            status TEXT NOT NULL,
            loan_date TEXT NOT NULL,
            due_date TEXT
        )
    \"\"\")
    # ëŒ€ì¶œ ìƒí™˜ ë‚´ì—­ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS loan_payments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            loan_id INTEGER NOT NULL,
            user_id TEXT NOT NULL,
            payment_amount INTEGER NOT NULL,
            payment_date TEXT NOT NULL,
            FOREIGN KEY (loan_id) REFERENCES loans(id)
        )
    \"\"\")

    # ì•…ì„± ì‚¬ìš©ì ë¸”ë™ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” (ê°œë…ì ì¸ êµ¬í˜„)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS global_blacklist (
            user_id TEXT PRIMARY KEY,
            username TEXT NOT NULL,
            reason TEXT,
            added_by TEXT,
            added_at TEXT
        )
    \"\"\")
    cursor.execute("INSERT OR IGNORE INTO global_blacklist (user_id, username, reason, added_by, added_at) VALUES ('123456789012345678', 'í…ŒìŠ¤íŠ¸ì•…ì„±ìœ ì €', 'ìë™í™” ë„ë°° ë´‡', 'system', datetime('now'))")
    cursor.execute("INSERT OR IGNORE INTO global_blacklist (user_id, username, reason, added_by, added_at) VALUES ('987654321098765432', 'ê´‘ê³ ìš©ê³„ì •', 'ìŠ¤íŒ¸ ê´‘ê³ ', 'system', datetime('now'))")

    # ğŸš© ë³µêµ¬ ë°ì´í„° í…Œì´ë¸” (SQLite)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS recovery_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            guild_id TEXT UNIQUE NOT NULL,
            snapshot_time TEXT NOT NULL,
            channels_json TEXT,
            roles_json TEXT,
            server_info_json TEXT,
            members_roles_json TEXT
        )
    \"\"\")

    conn.commit()
    conn.close()
    print(f"âœ… {BOT_NAME}: SQLite ë°ì´í„°ë² ì´ìŠ¤ '{DB_FILE}' ì´ˆê¸°í™” ì™„ë£Œ!")

# ì„œë²„ë³„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
def get_server_config(guild_id):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM server_configs WHERE guild_id = ?", (str(guild_id),))
    config = cursor.fetchone()
    conn.close()
    return config

# ì„œë²„ë³„ ì„¤ì • ì—…ë°ì´íŠ¸/ì‚½ì… í—¬í¼ í•¨ìˆ˜
def set_server_config(guild_id, config_name, config_value):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute(f\"\"\"
        INSERT INTO server_configs (guild_id, {config_name}) VALUES (?, ?)
        ON CONFLICT(guild_id) DO UPDATE SET {config_name} = EXCLUDED.{config_name}
    \"\"\", (str(guild_id), str(config_value)))
    conn.commit()
    conn.close()

# íŠ¹ì • ëª…ë ¹ì–´ì˜ í™œì„±í™” ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
def is_command_enabled(guild_id: int, command_name: str) -> bool:
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT is_enabled FROM server_command_states WHERE guild_id = ? AND command_name = ?", (str(guild_id), command_name))
    result = cursor.fetchone()
    conn.close()
    return result[0] == 1 if result else True # ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™” (ì„¤ì • ì—†ìœ¼ë©´ ì¼œì§„ ìƒíƒœ)

# ëª…ë ¹ì–´ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
def set_command_enabled_state(guild_id: int, command_name: str, is_enabled: bool):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    enabled_val = 1 if is_enabled else 0
    cursor.execute(\"\"\"
        INSERT INTO server_command_states (guild_id, command_name, is_enabled)
        VALUES (?, ?, ?)
        ON CONFLICT(guild_id) DO UPDATE SET is_enabled = EXCLUDED.is_enabled
    \"\"\", (str(guild_id), command_name, enabled_val))
    conn.commit()
    conn.close()

# ë´‡ ìƒíƒœ ë° í™œë™ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
def get_bot_presence_settings():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT status, activity_type, activity_name FROM bot_presence_settings WHERE id = 1")
    settings = cursor.fetchone()
    conn.close()
    return settings if settings else {'status': 'online', 'activity_type': 'playing', 'activity_name': 'RP ì„œë²„ ìš´ì˜'} # ê¸°ë³¸ê°’

# ë´‡ ìƒíƒœ ë° í™œë™ ì„¤ì • ì—…ë°ì´íŠ¸
def set_bot_presence_settings(status, activity_type, activity_name):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute(\"\"\"
        INSERT OR REPLACE INTO bot_presence_settings (id, status, activity_type, activity_name)
        VALUES (1, ?, ?, ?)
    \"\"\", (status, activity_type, activity_name))
    conn.commit()
    conn.close()

initialize_db()


intents = discord.Intents.all()
intents.message_content = True # ë©”ì‹œì§€ ë‚´ìš© ì½ê¸° ê¶Œí•œ í™œì„±í™”

# ë´‡ ì ‘ë‘ì‚¬ ë³€ê²½ (opendiscordbot!) # ğŸš© ì´ë¦„ ë³€ê²½
bot = commands.Bot(command_prefix='ì €ìŠ¤íŠ¸ ', intents=intents)

BOT_NAME = "{bot_name}" # ğŸš© ë´‡ ì´ë¦„ ì‚¬ìš©
BOT_TOKEN = os.getenv("BOT_TOKEN")

# Flask API ì„œë²„ URL
FLASK_BACKEND_URL = os.getenv("FLASK_BACKEND_URL")
# Flask API í†µì‹  ë³´ì•ˆ í‚¤ (ë´‡->Flask API)
BOT_API_KEY = os.getenv("BOT_API_KEY")

# YouTube API í‚¤
YOUTUBE_API_KEY = os.getenv("YOUTUBE_API_KEY")

# ë´‡ ì†Œìœ ì ID
BOT_OWNER_ID = int(os.getenv("BOT_OWNER_ID", "0"))

# V4 ìˆœìˆ˜ ë´‡ìš©: ëŒ€ìƒ ê¸¸ë“œ ID
TARGET_GUILD_ID = int(os.getenv("TARGET_GUILD_ID", "0"))

# ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œ í”Œë˜ê·¸ (ìŠ¤í¬ë¦½íŠ¸ê°€ ì„¤ì •)
IS_PURE_BOT_MODE = os.getenv("IS_PURE_BOT_MODE") == "true"


if not FLASK_BACKEND_URL and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ API URL í•„ìˆ˜
    print("âŒ Flask_BACKEND_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ì—ì„œ APIë¡œ ë°ì´í„° í‘¸ì‹œ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.")
if not BOT_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ API í‚¤ í•„ìˆ˜
    print("âŒ BOT_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ì—ì„œ APIë¡œ ë°ì´í„° í‘¸ì‹œ ì‹œ ì¸ì¦ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
if not YOUTUBE_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œì—ì„œëŠ” ìœ íŠœë¸Œ API í•„ìš” ì—†ìŒ
    print("âŒ YOUTUBE_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ íŠœë¸Œ í™œë™ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
if not BOT_OWNER_ID: # ğŸš© BOT_OWNER_IDë¡œ ë³€ê²½
    print("âš ï¸ BOT_OWNER_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ ì†Œìœ ì ì „ìš© ëª…ë ¹ì–´ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
if IS_PURE_BOT_MODE and not TARGET_GUILD_ID: # ğŸš© ìˆœìˆ˜ ë´‡ ëª¨ë“œì¼ ë•Œ ê¸¸ë“œ ID í•„ìˆ˜
    print("âŒ ìˆœìˆ˜ ë´‡ ëª¨ë“œëŠ” TARGET_GUILD_IDê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")


@tasks.loop(minutes=1)
async def record_bot_status():
    status_info = {
        "bot_name": BOT_NAME,
        "last_heartbeat": datetime.datetime.now(datetime.UTC).isoformat(),
        "status": "Online",
        "message": "ì •ìƒ ì‘ë™ ì¤‘",
        "guild_count": len(bot.guilds) if bot.guilds else 0
    }

    # SQLiteì— ë¡œì»¬ë¡œ ì €ì¥ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute(\"\"\"
        INSERT OR REPLACE INTO bot_status (bot_name, last_heartbeat, status, message, guild_count)
        VALUES (?, ?, ?, ?, ?)
    \"\"\", (status_info["bot_name"], status_info["last_heartbeat"], status_info["status"], status_info["message"], status_info["guild_count"]))
    conn.commit()
    conn.close()

    # ğŸš© Flask APIë¡œ ë´‡ ìƒíƒœ í‘¸ì‹œ (ìˆœìˆ˜ ë´‡ ëª¨ë“œì—ì„œëŠ” API í˜¸ì¶œ ì•ˆ í•¨)
    if not IS_PURE_BOT_MODE and FLASK_BACKEND_URL:
        try:
            api_endpoint = f"{FLASK_BACKEND_URL}/api/bot_status"
            headers = {
                'Content-Type': "application/json",
                'X-Api-Key': BOT_API_KEY
            }
            response = requests.post(api_endpoint, json=status_info, headers=headers)
            if response.status_code == 200:
                print(f"âœ… ë´‡ ìƒíƒœ ì •ë³´ Flask APIë¡œ ì „ì†¡ ì„±ê³µ: {response.status_code}")
            else:
                print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì „ì†¡ ì‹¤íŒ¨: {response.status_code} - {response.text}")
        except requests.exceptions.ConnectionError as e:
            print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì—°ê²° ì˜¤ë¥˜: {e}")
        except Exception as e:
            print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì „ì†¡ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜: {e}")


@tasks.loop(minutes=5)
async def update_bot_presence():
    settings = get_bot_presence_settings()
    if not settings: return

    status_map = {
        'online': discord.Status.online,
        'idle': discord.Status.idle,
        'dnd': discord.Status.dnd,
        'invisible': discord.Status.invisible
    }
    activity_type_map = {
        'playing': discord.ActivityType.playing,
        'listening': discord.ActivityType.listening,
        'watching': discord.ActivityType.watching,
        'streaming': discord.ActivityType.streaming
    }

    discord_status = status_map.get(settings['status'], discord.Status.online)
    discord_activity_type = activity_type_map.get(settings['activity_type'], discord.ActivityType.playing)

    activity = discord.Activity(type=discord_activity_type, name=settings['activity_name'])

    await bot.change_presence(status=discord_status, activity=activity)
    print(f"âœ… ë´‡ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ìƒíƒœ={settings['status']}, í™œë™={settings['activity_type']} {settings['activity_name']}")


@bot.event
async def on_ready():
    print(f'ğŸš€ {bot.user.name} ë´‡ ì¤€ë¹„ ì™„ë£Œ! ëª¨ë“  ê¸°ëŠ¥ ì•¼ë¬´ì§€ê²Œ ì‹œì‘í•©ë‹ˆë‹¤.')
    try:
        # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì¼ ê²½ìš° íŠ¹ì • ê¸¸ë“œì—ë§Œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”
        if IS_PURE_BOT_MODE and TARGET_GUILD_ID:
            target_guild_obj = bot.get_guild(TARGET_GUILD_ID)
            if target_guild_obj:
                await bot.tree.sync(guild=target_guild_obj) # íŠ¹ì • ê¸¸ë“œì—ë§Œ ë™ê¸°í™”
                print(f"âœ… ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì™„ë£Œ! (ëŒ€ìƒ ê¸¸ë“œ: {target_guild_obj.name})")
            else:
                print(f"âŒ ëŒ€ìƒ ê¸¸ë“œ ({TARGET_GUILD_ID})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        else: # ê·¸ ì™¸ ë²„ì „ì€ ê¸€ë¡œë²Œ ë™ê¸°í™” (V1, V2, V3)
            await bot.tree.sync() # ê¸€ë¡œë²Œ ë™ê¸°í™”
            print(f"âœ… ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì™„ë£Œ! (ê¸€ë¡œë²Œ)")
    except Exception as e:
        print(f"âŒ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì‹¤íŒ¨: {e}")
    record_bot_status.start()
    update_bot_presence.start()

    # Cogs ë¡œë“œ ì‹œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ bot ê°ì²´ì— ì§ì ‘ í• ë‹¹
    bot.get_server_config = get_server_config
    bot.set_server_config = set_server_config
    bot.get_db_connection = get_db_connection
    bot.is_command_enabled = is_command_enabled
    bot.set_command_enabled_state = set_command_enabled_state
    bot.get_bot_presence_settings = get_bot_presence_settings
    bot.set_bot_presence_settings = set_bot_presence_settings
    bot.FLASK_BACKEND_URL = FLASK_BACKEND_URL
    bot.BOT_API_KEY = BOT_API_KEY
    bot.BOT_OWNER_ID = BOT_OWNER_ID # ğŸš© BOT_OWNER_IDë¡œ ë³€ê²½

    # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì¼ ê²½ìš° Flask API í•¨ìˆ˜ë“¤ì„ Noneìœ¼ë¡œ ì„¤ì •
    if IS_PURE_BOT_MODE:
        bot.send_recovery_snapshot_to_api = None
        bot.get_recovery_snapshot_from_api = None
    else:
        bot.send_recovery_snapshot_to_api = send_recovery_snapshot_to_api
        bot.get_recovery_snapshot_from_api = get_recovery_snapshot_from_api

    if YOUTUBE_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œì—ì„œëŠ” ìœ íŠœë¸Œ API í•„ìš” ì—†ìŒ
        try:
            bot.youtube_service = build('youtube', 'v3', developerKey=YOUTUBE_API_KEY)
            print("âœ… YouTube Data API ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ.")
        except Exception as e:
            print(f"âŒ YouTube Data API ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹¤íŒ¨: {e}")
            bot.youtube_service = None
    else:
        bot.youtube_service = None


    cogs_to_load = [
        "cogs.bank",
        "cogs.car",
        "cogs.moderation",
        "cogs.music",
        "cogs.game",
        "cogs.youtube_tracker"
    ]
    for cog in cogs_to_load:
        # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì—ì„œëŠ” youtube_tracker ë¡œë“œí•˜ì§€ ì•ŠìŒ (API ì„œë²„ ì—†ìœ¼ë¯€ë¡œ)
        if IS_PURE_BOT_MODE and cog == "cogs.youtube_tracker":
            print("âš ï¸ ìˆœìˆ˜ ë´‡ ëª¨ë“œì—ì„œëŠ” youtube_tracker ì½”ê·¸ë¥¼ ë¡œë“œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            continue
        try:
            await bot.load_extension(cog)
            print(f"ë¡œë“œ ì„±ê³µ: {cog}")
        except Exception as e:
            print(f"ë¡œë“œ ì‹¤íŒ¨: {cog} - {e}")

    # ë´‡ì´ ì¼œì§ˆ ë•Œ guild_nameì´ ì—†ëŠ” server_configs í•­ëª©ì„ ì±„ì›Œ ë„£ê¸°
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT guild_id FROM server_configs WHERE guild_name IS NULL")
    guild_ids_without_name = cursor.fetchall()

    for guild_row in guild_ids_without_name:
        guild_id = int(guild_row['guild_id'])
        guild = bot.get_guild(guild_id)
        if guild:
            cursor.execute("UPDATE server_configs SET guild_name = ? WHERE guild_id = ?", (guild.name, str(guild_id)))
            print(f"âœ… ì„œë²„ ID {guild_id}ì˜ ì´ë¦„ '{guild.name}'ì„(ë¥¼) DBì— ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.")
        else:
            print(f"âš ï¸ ë´‡ì´ ê¸¸ë“œ {guild_id}ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸¸ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë´‡ì´ ì„œë²„ì— ì—†ìŠµë‹ˆë‹¤.")
    conn.commit()
    conn.close()


@bot.event
async def on_message(message):
    if message.author == bot.user or not message.guild:
        return

    await bot.process_commands(message)


@bot.event
async def on_member_join(member: discord.Member):
    """ë©¤ë²„ê°€ ì„œë²„ì— ê°€ì…í•  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤."""
    if member.bot: return
    guild = member.guild
    config = get_server_config(guild.id)

    if config and config.get('welcome_message_enabled', 0):
        channel_id = config.get('log_channel_id')
        if not channel_id: return

        channel = bot.get_channel(int(channel_id))
        if channel:
            message_text = config.get('welcome_message_text', "ì–´ì„œì˜¤ì„¸ìš”, {user}ë‹˜!")
            message_text = message_text.replace("{user}", member.mention)
            message_text = message_text.replace("{server}", guild.name)
            message_text = message_text.replace("{member_count}", str(guild.member_count))
            try:
                await channel.send(message_text)
            except discord.Forbidden:
                print(f"âŒ ì±„ë„ {channel.name}ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")

@bot.event
async def on_member_remove(member: discord.Member):
    """ë©¤ë²„ê°€ ì„œë²„ë¥¼ ë– ë‚  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤."""
    if member.bot: return
    guild = member.guild
    config = get_server_config(guild.id)

    if config and config.get('leave_message_enabled', 0):
        channel_id = config.get('log_channel_id')
        if not channel_id: return

        channel = bot.get_channel(int(channel_id))
        if channel:
            message_text = config.get('leave_message_text', "ì•ˆë…•íˆê°€ì„¸ìš”, {user}ë‹˜.")
            message_text = message_text.replace("{user}", member.display_name)
            message_text = message_text.replace("{server}", guild.name)
            message_text = message_text.replace("{member_count}", str(guild.member_count))
            try:
                await channel.send(message_text)
            except discord.Forbidden:
                print(f"âŒ ì±„ë„ {channel.name}ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")


@bot.event
async def on_interaction(interaction: discord.Interaction):
    if interaction.type == discord.InteractionType.application_command and interaction.guild:
        command_name_parts = [interaction.command.name]
        if interaction.command.parent:
            command_name_parts.insert(0, interaction.command.parent.name)
            if interaction.command.parent.parent:
                command_name_parts.insert(0, interaction.command.parent.parent.name)
        full_command_name = " ".join(command_name_parts)

        if not is_command_enabled(interaction.guild.id, full_command_name):
            await interaction.response.send_message(f"âŒ ì´ ëª…ë ¹ì–´ (`/{full_command_name}`)ëŠ” í˜„ì¬ ì´ ì„œë²„ì—ì„œ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤ã€‚", ephemeral=True)
            return
    
    await bot.process_commands(interaction)


@bot.event
async def on_app_command_error_global(interaction: discord.Interaction, error: app_commands.AppCommandError):
    if interaction.response.is_done():
        print(f"ì˜¤ë¥˜ ë°œìƒ (ì´ë¯¸ ì‘ë‹µ ì „ì†¡ë¨): {error}")
        return

    if isinstance(error, app_commands.CommandInvokeError):
        print(f"ì „ì—­ ì˜¤ë¥˜ ë°œìƒ: {error.original}")
        await interaction.response.send_message(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error.original}", ephemeral=True)

    elif isinstance(error, app_commands.MissingPermissions):
        await interaction.response.send_message("âŒ ì´ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì(Administrator) ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤ã€‚", ephemeral=True)
    elif isinstance(error, app_commands.CommandOnCooldown):
        await interaction.response.send_message(f"âŒ ì´ ëª…ë ¹ì–´ëŠ” ì¿¨íƒ€ì„ ì¤‘ì…ë‹ˆë‹¤. {error.retry_after:.2f}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”ã€‚", ephemeral=True)
    else:
        print(f"ì•Œ ìˆ˜ ì—†ëŠ” ì „ì—­ ì˜¤ë¥˜: {error}")
        await interaction.response.send_message(f"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error}", ephemeral=True)

try:
    bot.run(BOT_TOKEN)
except discord.LoginFailure:
    print("âŒ ë´‡ í† í°ì´ ì˜¬ë°”ë¥´ì§€ ì•Šê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. í† í°ì„ í™•ì¸í•´ì£¼ì„¸ìš”!")
except Exception as e:
    print(f"âŒ ë´‡ ì‹¤í–‰ ì¤‘ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}")


# ğŸš© ë³µêµ¬ ë´‡ API í†µì‹  í•¨ìˆ˜ ì¶”ê°€ (bot.pyì— ì§ì ‘ ì •ì˜)
async def send_recovery_snapshot_to_api(guild_id, snapshot_data):
    """ì„œë²„ ìŠ¤ëƒ…ìƒ· ë°ì´í„°ë¥¼ Flask API ì„œë²„ë¡œ ì „ì†¡í•©ë‹ˆë‹¤."""
    # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì—ì„œëŠ” API í†µì‹  ì•ˆ í•¨. SQLiteì— ì§ì ‘ ì €ì¥.
    if os.getenv("IS_PURE_BOT_MODE") == "true":
        conn = get_db_connection()
        cursor = conn.cursor()
        try:
            cursor.execute(\"\"\"
                CREATE TABLE IF NOT EXISTS recovery_data (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    guild_id TEXT UNIQUE NOT NULL,
                    snapshot_time TEXT NOT NULL,
                    channels_json TEXT,
                    roles_json TEXT,
                    server_info_json TEXT,
                    members_roles_json TEXT
                )
            \"\"\")
            cursor.execute(\"\"\"
                INSERT OR REPLACE INTO recovery_data (guild_id, snapshot_time, channels_json, roles_json, server_info_json, members_roles_json)
                VALUES (?, ?, ?, ?, ?, ?)
            \"\"\", (
                str(guild_id),
                datetime.datetime.now(datetime.UTC).isoformat(),
                json.dumps(snapshot_data.get('channels', [])),
                json.dumps(snapshot_data.get('roles', [])),
                json.dumps(snapshot_data.get('server_info', {})),
                json.dumps(snapshot_data.get('members_roles', []))
            ))
            conn.commit()
            print(f"âœ… ë³µêµ¬ ìŠ¤ëƒ…ìƒ· ë¡œì»¬ SQLiteì— ì €ì¥ ì™„ë£Œ: {guild_id}")
            return True
        except sqlite3.Error as e:
            print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· ë¡œì»¬ ì €ì¥ ì˜¤ë¥˜: {e}")
            return False
        finally:
            cursor.close()
            conn.close()

    if not os.getenv("IS_FLASK_API_ENABLED") == "true" or not os.getenv("BOT_API_KEY"): # Flask APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ API í‚¤ ì—†ìœ¼ë©´ í†µì‹  ì•ˆ í•¨
        print("âš ï¸ Flask APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ BOT_API_KEYê°€ ì—†ì–´ ë³µêµ¬ ìŠ¤ëƒ…ìƒ·ì„ ì „ì†¡í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return False
    
    api_endpoint = f"{os.getenv('FLASK_BACKEND_URL')}/api/recovery/snapshot"
    headers = {
        'Content-Type': "application/json",
        'X-Api-Key': os.getenv("BOT_API_KEY")
    }
    payload = {
        'guild_id': str(guild_id),
        'snapshot_data': snapshot_data
    }
    
    try:
        response = requests.post(api_endpoint, json=payload, headers=headers)
        if response.status_code == 200:
            print(f"âœ… ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask APIë¡œ ì „ì†¡ ì„±ê³µ: {response.status_code}")
            return True
        else:
            print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ì „ì†¡ ì‹¤íŒ¨: {response.status_code} - {response.text}")
            return False
    except requests.exceptions.ConnectionError as e:
        print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ì—°ê²° ì˜¤ë¥˜: {e}")
        return False
    except Exception as e:
        print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ì „ì†¡ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜: {e}")
        return False

async def get_recovery_snapshot_from_api(guild_id):
    """Flask API ì„œë²„ë¡œë¶€í„° íŠ¹ì • ì„œë²„ì˜ ìµœì‹  ìŠ¤ëƒ…ìƒ· ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤."""
    # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì—ì„œëŠ” API í†µì‹  ì•ˆ í•¨. SQLiteì—ì„œ ì§ì ‘ ê°€ì ¸ì˜´.
    if os.getenv("IS_PURE_BOT_MODE") == "true":
        conn = get_db_connection()
        cursor = conn.cursor()
        try:
            cursor.execute(\"\"\"
                CREATE TABLE IF NOT EXISTS recovery_data (
                    id INTEGER PRIMARY KEY AUTOINCREMENT,
                    guild_id TEXT UNIQUE NOT NULL,
                    snapshot_time TEXT NOT NULL,
                    channels_json TEXT,
                    roles_json TEXT,
                    server_info_json TEXT,
                    members_roles_json TEXT
                )
            \"\"\")
            cursor.execute(\"\"\"
                SELECT channels_json, roles_json, server_info_json, members_roles_json FROM recovery_data
                WHERE guild_id = ? ORDER BY snapshot_time DESC LIMIT 1
            \"\"\", (str(guild_id),))
            snapshot_row = cursor.fetchone()
            if snapshot_row:
                return {
                    "guild_id": str(guild_id),
                    "channels": json.loads(snapshot_row['channels_json']),
                    "roles": json.loads(snapshot_row['roles_json']),
                    "server_info": json.loads(snapshot_row['server_info_json']),
                    "members_roles": json.loads(snapshot_row['members_roles_json'])
                }
            else:
                return None
        except sqlite3.Error as e:
            print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· ë¡œì»¬ ì¡°íšŒ ì˜¤ë¥˜: {e}")
            return None
        finally:
            cursor.close()
            conn.close()

    if not os.getenv("IS_FLASK_API_ENABLED") == "true" or not os.getenv("BOT_API_KEY"): # Flask APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ API í‚¤ ì—†ìœ¼ë©´ í†µì‹  ì•ˆ í•¨
        print("âš ï¸ Flask APIê°€ í™œì„±í™”ë˜ì§€ ì•Šì•˜ê±°ë‚˜ BOT_API_KEYê°€ ì—†ì–´ ë³µêµ¬ ìŠ¤ëƒ…ìƒ·ì„ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None
    
    api_endpoint = f"{os.getenv('FLASK_BACKEND_URL')}/api/recovery/snapshot/{guild_id}"
    headers = {
        'Content-Type': "application/json",
        'X-Api-Key': os.getenv("BOT_API_KEY")
    }

    try:
        response = requests.get(api_endpoint, headers=headers)
        if response.status_code == 200:
            print(f"âœ… ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask APIë¡œë¶€í„° ë°ì´í„° ìˆ˜ì‹  ì„±ê³µ.")
            return response.json()
        elif response.status_code == 404:
            print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ·ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ì„œë²„ {guild_id}")
            return None
        else:
            print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ìˆ˜ì‹  ì‹¤íŒ¨: {response.status_code} - {response.text}")
            return None
    except requests.exceptions.RequestException as e:
        print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ì—°ê²° ì˜¤ë¥˜: {e}")
        return None
    except Exception as e:
        print(f"âŒ ë³µêµ¬ ìŠ¤ëƒ…ìƒ· Flask API ìˆ˜ì‹  ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜: {e}")
        return None
"""

# 2.7. cogs/moderation.py
def get_moderation_py_content(bot_name, currency_name):
    return f"""
import discord
from discord.ext import commands
from discord import app_commands
import sqlite3
import datetime
import json
import os
import re
import collections
import asyncio

class Moderation(commands.Cog):
    message_timestamps = collections.defaultdict(lambda: collections.defaultdict(collections.deque))

    def __init__(self, bot):
        self.bot = bot
        self.get_db_connection = bot.get_db_connection
        self.get_server_config = bot.get_server_config
        self.set_server_config = bot.set_server_config
        self.is_command_enabled = bot.is_command_enabled
        self.set_command_enabled_state = bot.set_command_enabled_state
        self.get_bot_presence_settings = bot.get_bot_presence_settings
        self.set_bot_presence_settings = bot.set_bot_presence_settings
        self.send_recovery_snapshot_to_api = bot.send_recovery_snapshot_to_api
        self.get_recovery_snapshot_from_api = bot.get_recovery_snapshot_from_api


    # --- ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ê·¸ë£¹ ---
    config_group = app_commands.Group(name="ì„¤ì •", description="ì´ ì„œë²„ì˜ ë´‡ ì„¤ì •ì„ ê´€ë¦¬í•©ë‹ˆë‹¤ã€‚", guild_only=True)
    recovery_group = app_commands.Group(name="ë³µêµ¬", description="ì„œë²„ ìŠ¤ëƒ…ìƒ·ì„ ìƒì„±í•˜ê±°ë‚˜ ë³µêµ¬í•©ë‹ˆë‹¤ã€‚", guild_only=True)

    # --- ê¶Œí•œ í™•ì¸ í—¬í¼ ë°ì½”ë ˆì´í„° ---
    # is_bot_owner: Trueë©´ ë´‡ ì†Œìœ ì(@opendiscordbot owner ID)ë§Œ
    # required_role_name: ì„œë²„ ê´€ë¦¬í•˜ê¸° ì—­í•  ë˜ëŠ” Administrator ê¶Œí•œ ì²´í¬ (ê¸°ë³¸ê°’ "ì„œë²„ ê´€ë¦¬í•˜ê¸°")
    async def _check_permission(self, interaction_or_ctx, is_bot_owner: bool = False, required_role_name: str = "ì„œë²„ ê´€ë¦¬í•˜ê¸°"):
        if isinstance(interaction_or_ctx, discord.Interaction):
            user = interaction_or_ctx.user
            guild = interaction_or_ctx.guild
            send_message_func = interaction_or_ctx.response.send_message
            is_ephemeral = True
        elif isinstance(interaction_or_ctx, commands.Context):
            user = interaction_or_ctx.author
            guild = interaction_or_ctx.guild
            send_message_func = interaction_or_ctx.send
            is_ephemeral = False
        else:
            return False

        # 1. ë´‡ ì†Œìœ ì ê¶Œí•œ í™•ì¸ (IDë¡œë§Œ ì²´í¬)
        if is_bot_owner:
            if user.id == self.bot.BOT_OWNER_ID:
                return True
            else:
                await send_message_func("âŒ ì´ ëª…ë ¹ì–´ëŠ” ë´‡ ì†Œìœ ìë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤ã€‚", ephemeral=is_ephemeral)
                return False

        # 2. 'ì„œë²„ ê´€ë¦¬í•˜ê¸°' ì—­í•  ë˜ëŠ” Administrator ê¶Œí•œ í™•ì¸ (ì¼ë°˜ ê´€ë¦¬ììš©)
        if guild: # ê¸¸ë“œì—ì„œ í˜¸ì¶œëœ ê²½ìš°ì—ë§Œ ì—­í• /ê¶Œí•œ ì²´í¬
            server_manager_role = discord.utils.get(guild.roles, name=required_role_name)
            if server_manager_role and server_manager_role in user.roles:
                return True

            if user.guild_permissions.administrator:
                return True

        # ì–´ë–¤ ì¡°ê±´ë„ ë§Œì¡±í•˜ì§€ ëª»í–ˆì„ ê²½ìš°
        if required_role_name:
            await send_message_func(f"âŒ ì´ ëª…ë ¹ì–´ëŠ” '{required_role_name}' ì—­í•  ë˜ëŠ” Administrator ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤ã€‚", ephemeral=is_ephemeral)
        else:
            await send_message_func("âŒ ì´ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ã€‚", ephemeral=is_ephemeral)
        return False

    # ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œìš© ì»¤ìŠ¤í…€ ê¶Œí•œ ì²´í¬ (interaction ê°ì²´ ì‚¬ìš©)
    def _is_server_manager_check(self, interaction: discord.Interaction):
        return self._check_permission(interaction, is_bot_owner=False)

    def _is_bot_owner_command_check(self, interaction: discord.Interaction):
        return self._check_permission(interaction, is_bot_owner=True)

    # ë©”ì‹œì§€ ì»¤ë§¨ë“œìš© ì»¤ìŠ¤í…€ ê¶Œí•œ ì²´í¬ (commands.Context ê°ì²´ ì‚¬ìš©)
    def _is_server_manager_msg_check(self, ctx: commands.Context):
        return self._check_permission(ctx, is_bot_owner=False)

    def _is_bot_owner_msg_check(self, ctx: commands.Context):
        return self._check_permission(ctx, is_bot_owner=True)


    # --- ì±„ë„/ì—­í•  ì„¤ì • í—¬í¼ í•¨ìˆ˜ ---
    async def _set_channel_config(self, guild_id, config_name, channel, interaction=None, ctx=None):
        self.set_server_config(guild_id, config_name, channel.id)
        response_msg = f"âœ… {channel.mention}ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
        if interaction:
            await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx:
            await ctx.send(response_msg)

    async def _set_role_config(self, guild_id, config_name, role, interaction=None, ctx=None):
        self.set_server_config(guild_id, config_name, role.id)
        response_msg = f"âœ… {role.mention}ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤."
        if interaction:
            await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx:
            await ctx.send(response_msg)

    @config_group.command(name="ì°¨ëŸ‰ë“±ë¡ì±„ë„", description="ì°¨ëŸ‰ ë“±ë¡ ì‹ ì²­ í¬ìŠ¤íŠ¸ê°€ ì˜¬ë¼ì˜¬ ì±„ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì±„ë„="ì„¤ì •í•  ì±„ë„")
    @app_commands.check(_is_server_manager_check)
    async def set_registration_channel(self, interaction: discord.Interaction, ì±„ë„: discord.TextChannel):
        await self._set_channel_config(interaction.guild.id, 'registration_channel_id', ì±„ë„, interaction)

    @config_group.command(name="ì°¨ëŸ‰ê´€ë¦¬ì±„ë„", description="ì°¨ëŸ‰ ë“±ë¡ ì•Œë¦¼ ë° ê´€ë¦¬ ë²„íŠ¼ì´ í‘œì‹œë  ì±„ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì±„ë„="ì„¤ì •í•  ì±„ë„")
    @app_commands.check(_is_server_manager_check)
    async def set_car_admin_channel(self, interaction: discord.Interaction, ì±„ë„: discord.TextChannel):
        await self._set_channel_config(interaction.guild.id, 'car_admin_channel_id', ì±„ë„, interaction)

    @config_group.command(name="ì°¨ëŸ‰ê´€ë¦¬ì—­í• ", description="ì°¨ëŸ‰ ë“±ë¡ ì•Œë¦¼ ë©˜ì…˜ì„ ë°›ì„ ê´€ë¦¬ì ì—­í• ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì—­í• ="ì„¤ì •í•  ì—­í• ")
    @app_commands.check(_is_server_manager_check)
    async def set_car_admin_role(self, interaction: discord.Interaction, ì—­í• : discord.Role):
        await self._set_role_config(interaction.guild.id, 'car_admin_role_id', ì—­í• , interaction)

    @config_group.command(name="ì°¨ëŸ‰ìŠ¹ì¸ì±„ë„", description="ìŠ¹ì¸ëœ ì°¨ëŸ‰ ë“±ë¡ì¦ì´ ì˜¬ë¼ì˜¬ ì±„ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì±„ë„="ì„¤ì •í•  ì±„ë„")
    @app_commands.check(_is_server_manager_check)
    async def set_approved_cars_channel(self, interaction: discord.Interaction, ì±„ë„: discord.TextChannel):
        await self._set_channel_config(interaction.guild.id, 'approved_cars_channel_id', ì±„ë„, interaction)

    @config_group.command(name="ì€í–‰ì±„ë„", description="ì€í–‰ ê´€ë ¨ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ì±„ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì±„ë„="ì„¤ì •í•  ì±„ë„")
    @app_commands.check(_is_server_manager_check)
    async def set_bank_channel(self, interaction: discord.Interaction, ì±„ë„: discord.TextChannel):
        await self._set_channel_config(interaction.guild.id, 'bank_channel_id', ì±„ë„, interaction)

    @config_group.command(name="í‹°ì¼“ê°œì„¤ì±„ë„", description="ì‚¬ìš©ìê°€ /ticket openì„ ì‚¬ìš©í•  ìˆ˜ ìˆëŠ” ì±„ë„ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì±„ë„="ì„¤ì •í•  ì±„ë„")
    @app_commands.check(_is_server_manager_check)
    async def set_ticket_open_channel(self, interaction: discord.Interaction, ì±„ë„: discord.TextChannel):
        await self._set_channel_config(interaction.guild.id, 'ticket_open_channel_id', ì±„ë„, interaction)

    @config_group.command(name="í‹°ì¼“ì¹´í…Œê³ ë¦¬", description="ìƒˆ í‹°ì¼“ ì±„ë„ì´ ìƒì„±ë  ì¹´í…Œê³ ë¦¬ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì¹´í…Œê³ ë¦¬="ì„¤ì •í•  ì¹´í…Œê³ ë¦¬")
    @app_commands.check(_is_server_manager_check)
    async def set_ticket_category(self, interaction: discord.Interaction, ì¹´í…Œê³ ë¦¬: discord.CategoryChannel):
        self.set_server_config(interaction.guild.id, 'ticket_category_id', ì¹´í…Œê³ ë¦¬.id)
        await interaction.response.send_message(f"âœ… í‹°ì¼“ ì¹´í…Œê³ ë¦¬ê°€ '{ì¹´í…Œê³ ë¦¬.name}'ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", ephemeral=True)

    @config_group.command(name="í‹°ì¼“ê´€ë¦¬ì—­í• ", description="í‹°ì¼“ ì±„ë„ì— ìë™ ì¶”ê°€ë  ìŠ¤íƒœí”„ ì—­í• ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì—­í• ="ì„¤ì •í•  ì—­í• ")
    @app_commands.check(_is_server_manager_check)
    async def set_ticket_staff_role(self, interaction: discord.Interaction, ì—­í• : discord.Role):
        await self._set_role_config(interaction.guild.id, 'ticket_staff_role_id', ì—­í• , interaction)

    @config_group.command(name="ë“±ë¡ì„¸", description="ì°¨ëŸ‰ ë“±ë¡ì„¸ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ê¸ˆì•¡="ì„¤ì •í•  ë“±ë¡ì„¸ ê¸ˆì•¡")
    @app_commands.check(_is_server_manager_check)
    async def set_registration_tax(self, interaction: discord.Interaction, ê¸ˆì•¡: int):
        self.set_server_config(interaction.guild.id, 'car_registration_tax', ê¸ˆì•¡)
        await interaction.response.send_message(f"âœ… ì°¨ëŸ‰ ë“±ë¡ì„¸ê°€ **{ê¸ˆì•¡} ìœ„í‚¤ì›**ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤.", ephemeral=True)

    @config_group.command(name="í™˜ì˜ë©”ì‹œì§€", description="ìƒˆ ë©¤ë²„ê°€ ê°€ì…í•  ë•Œ ë³´ë‚¼ ë©”ì‹œì§€ì™€ í™œì„±í™” ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ë©”ì‹œì§€="ë³´ë‚¼ ë©”ì‹œì§€ ({user}, {server}, {member_count} í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš© ê°€ëŠ¥)", í™œì„±í™”="í™˜ì˜ ë©”ì‹œì§€ í™œì„±í™” ì—¬ë¶€")
    @app_commands.choices(í™œì„±í™”=[app_commands.Choice(name="í™œì„±í™”", value=True), app_commands.Choice(name="ë¹„í™œì„±í™”", value=False)])
    @app_commands.check(_is_server_manager_check)
    async def set_welcome_message(self, interaction: discord.Interaction, ë©”ì‹œì§€: str, í™œì„±í™”: bool):
        self.set_server_config(interaction.guild.id, 'welcome_message_text', ë©”ì‹œì§€)
        self.set_server_config(interaction.guild.id, 'welcome_message_enabled', í™œì„±í™”)
        status = "í™œì„±í™”" if í™œì„±í™” else "ë¹„í™œì„±í™”"
        await interaction.response.send_message(f"âœ… í™˜ì˜ ë©”ì‹œì§€ê°€ '{ë©”ì‹œì§€}'ë¡œ ì„¤ì •ë˜ì—ˆìœ¼ë©°, ê¸°ëŠ¥ì´ {status}ë˜ì—ˆìŠµë‹ˆë‹¤.", ephemeral=True)

    @config_group.command(name="ì‘ë³„ë©”ì‹œì§€", description="ë©¤ë²„ê°€ ë– ë‚  ë•Œ ë³´ë‚¼ ë©”ì‹œì§€ì™€ í™œì„±í™” ì—¬ë¶€ë¥¼ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(ë©”ì‹œì§€="ë³´ë‚¼ ë©”ì‹œì§€ ({user}, {server}, {member_count} í”Œë ˆì´ìŠ¤í™€ë” ì‚¬ìš© ê°€ëŠ¥)", í™œì„±í™”="ì‘ë³„ ë©”ì‹œì§€ í™œì„±í™” ì—¬ë¶€")
    @app_commands.choices(í™œì„±í™”=[app_commands.Choice(name="í™œì„±í™”", value=True), app_commands.Choice(name="ë¹„í™œì„±í™”", value=False)])
    @app_commands.check(_is_server_manager_check)
    async def set_leave_message(self, interaction: discord.Interaction, ë©”ì‹œì§€: str, í™œì„±í™”: bool):
        self.set_server_config(interaction.guild.id, 'leave_message_text', ë©”ì‹œì§€)
        self.set_server_config(interaction.guild.id, 'leave_message_enabled', í™œì„±í™”)
        status = "í™œì„±í™”" if í™œì„±í™” else "ë¹„í™œì„±í™”"
        await interaction.response.send_message(f"âœ… ì‘ë³„ ë©”ì‹œì§€ê°€ '{ë©”ì‹œì§€}'ë¡œ ì„¤ì •ë˜ì—ˆìœ¼ë©°, ê¸°ëŠ¥ì´ {status}ë˜ì—ˆìŠµë‹ˆë‹¤ã€‚", ephemeral=True)

    @config_group.command(name="ìœ íŠœë¸Œí™œë™", description="ìœ íŠœë¸Œ ì±„ë„ ìƒˆ ì˜ìƒ ì•Œë¦¼ ê¸°ëŠ¥ì„ ì„¤ì •í•©ë‹ˆë‹¤.")
    @app_commands.describe(í™œì„±í™”="ê¸°ëŠ¥ í™œì„±í™” ì—¬ë¶€", ì•Œë¦¼ì±„ë„="ìƒˆ ì˜ìƒ ì•Œë¦¼ì„ ë³´ë‚¼ ì±„ë„", ì±„ë„id="ëª¨ë‹ˆí„°ë§í•  ìœ íŠœë¸Œ ì±„ë„ ID (ì‰¼í‘œë¡œ êµ¬ë¶„)")
    @app_commands.choices(í™œì„±í™”=[app_commands.Choice(name="í™œì„±í™”", value=True), app_commands.Choice(name="ë¹„í™œì„±í™”", value=False)])
    @app_commands.check(_is_server_manager_check)
    async def set_youtube_activity(self, interaction: discord.Interaction, í™œì„±í™”: bool, ì•Œë¦¼ì±„ë„: discord.TextChannel, ì±„ë„id: str = ""):
        self.set_server_config(interaction.guild.id, 'youtube_activity_enabled', í™œì„±í™”)
        self.set_server_config(interaction.guild.id, 'youtube_notification_channel_id', ì•Œë¦¼ì±„ë„.id)

        youtube_channel_ids = [cid.strip() for cid in ì±„ë„id.split(',') if cid.strip()]
        self.set_server_config(interaction.guild.id, 'youtube_channel_ids_json', json.dumps(youtube_channel_ids))

        status_msg = "í™œì„±í™”" if í™œì„±í™” else "ë¹„í™œì„±í™”"
        ids_msg = f"ëª¨ë‹ˆí„°ë§ ì±„ë„: {', '.join(youtube_channel_ids) if youtube_channel_ids else 'ì—†ìŒ'}"
        await interaction.response.send_message(f"âœ… ìœ íŠœë¸Œ í™œë™ ì•Œë¦¼ ê¸°ëŠ¥ì´ {status_msg}ë˜ì—ˆìŠµë‹ˆë‹¤. ì•Œë¦¼ ì±„ë„: {ì•Œë¦¼ì±„ë„.mention}. {ids_msg}", ephemeral=True)

    @config_group.command(name="ëª¨ë“ ì„¤ì •í™•ì¸", description="ì´ ì„œë²„ì˜ í˜„ì¬ ë´‡ ì„¤ì •ë“¤ì„ í™•ì¸í•©ë‹ˆë‹¤.")
    @app_commands.check(_is_server_manager_check)
    async def show_all_configs(self, interaction: discord.Interaction):
        server_config = self.bot.get_server_config(interaction.guild.id)
        if not server_config:
            await interaction.response.send_message("âŒ ì´ ì„œë²„ì— ì €ì¥ëœ ë´‡ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. `/ì„¤ì •` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ ì„¤ì •í•´ì£¼ì„¸ìš”ã€‚", ephemeral=True)
            return

        config_details = "--- í˜„ì¬ ì„œë²„ ì„¤ì • ---\n"
        for key, value in server_config.items():
            if key == 'guild_id':
                config_details += f"**ì„œë²„ ID:** {value}\n"
            elif key == 'guild_name':
                config_details += f"**ì„œë²„ ì´ë¦„:** {value if value else 'ë¯¸ì§€ì •'}\n"
            elif '_channel_id' in key and value:
                channel = self.bot.get_channel(int(value))
                config_details += f"**{key.replace('_id', '').replace('_channel', ' ì±„ë„')}:** {channel.mention if channel else 'ì±„ë„ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ'} (`{value}`)\n"
            elif '_role_id' in key and value:
                role = interaction.guild.get_role(int(value))
                config_details += f"**{key.replace('_id', '').replace('_role', ' ì—­í• ')}:** {role.mention if role else 'ì—­í• ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ'} (`{value}`)\n"
            elif '_category_id' in key and value:
                category = self.bot.get_channel(int(value))
                config_details += f"**{key.replace('_id', '').replace('_category', ' ì¹´í…Œê³ ë¦¬')}:** {category.name if category else 'ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ'} (`{value}`)\n"
            elif 'json' in key:
                display_value = value
                try:
                    parsed_json = json.loads(value)
                    display_value = str(parsed_json)
                except json.JSONDecodeError:
                    pass
                config_details += f"**{key.replace('_json', ' (JSON)')}:** {display_value}\n"
            else:
                display_value = value
                if isinstance(value, int) and (key.endswith('_enabled') or key.endswith('_active')):
                    display_value = "í™œì„±í™” âœ…" if value == 1 else "ë¹„í™œì„±í™” âŒ"
                config_details += f"**{key}:** {display_value}\n"

        embed = discord.Embed(
            title=f"{interaction.guild.name} ì„œë²„ì˜ ë´‡ ì„¤ì •",
            description=config_details,
            color=discord.Color.blue()
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)

    @config_group.command(name="ë´‡ìƒíƒœì„¤ì •", description="ë´‡ì˜ Discord ìƒíƒœì™€ í™œë™ì„ ì„¤ì •í•©ë‹ˆë‹¤ (ë´‡ ì†Œìœ ì ì „ìš©)ã€‚")
    @app_commands.describe(
        ìƒíƒœ="ë´‡ì˜ ìƒíƒœ (ì˜¨ë¼ì¸, ìë¦¬ë¹„ì›€, ë°©í•´ê¸ˆì§€, ì˜¤í”„ë¼ì¸í‘œì‹œ)",
        í™œë™ìœ í˜•="í™œë™ ìœ í˜• (í”Œë ˆì´ì¤‘, ìŠ¤íŠ¸ë¦¬ë°ì¤‘, ë“£ëŠ”ì¤‘, ì‹œì²­ì¤‘)",
        í™œë™ë©”ì‹œì§€="í™œë™ì— í‘œì‹œí•  ë©”ì‹œì§€"
    )
    @app_commands.check(_is_bot_owner_command_check)
    async def set_bot_status_command(self, interaction: discord.Interaction,
                                     ìƒíƒœ: str, í™œë™ìœ í˜•: str, í™œë™ë©”ì‹œì§€: str):
        valid_status = ['ì˜¨ë¼ì¸', 'ìë¦¬ë¹„ì›€', 'ë°©í•´ê¸ˆì§€', 'ì˜¤í”„ë¼ì¸í‘œì‹œ']
        valid_activity_type = ['í”Œë ˆì´ì¤‘', 'ìŠ¤íŠ¸ë¦¬ë°ì¤‘', 'ë“£ëŠ”ì¤‘', 'ì‹œì²­ì¤‘']

        if ìƒíƒœ not in valid_status:
            await interaction.response.send_message(f"âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ìƒíƒœì…ë‹ˆë‹¤. ({', '.join(valid_status)} ì¤‘ ì„ íƒ)", ephemeral=True)
            return
        if í™œë™ìœ í˜• not in valid_activity_type:
            await interaction.response.send_message(f"âŒ ìœ íš¨í•˜ì§€ ì•Šì€ í™œë™ ìœ í˜•ì…ë‹ˆë‹¤. ({', '.join(valid_activity_type)} ì¤‘ ì„ íƒ)", ephemeral=True)
            return

        status_map = {'online': 'online', 'ìë¦¬ë¹„ì›€': 'idle', 'ë°©í•´ê¸ˆì§€': 'dnd', 'ì˜¤í”„ë¼ì¸í‘œì‹œ': 'invisible'}
        activity_type_map = {'playing': 'playing', 'ìŠ¤íŠ¸ë¦¬ë°ì¤‘': 'streaming', 'ë“£ëŠ”ì¤‘': 'listening', 'ì‹œì²­ì¤‘': 'watching'}

        self.set_bot_presence_settings(
            status_map[ìƒíƒœ],
            activity_type_map[í™œë™ìœ í˜•],
            í™œë™ë©”ì‹œì§€
        )
        await interaction.response.send_message(f"âœ… ë´‡ì˜ Discord ìƒíƒœê°€ ì„±ê³µì ìœ¼ë¡œ ì„¤ì •ë˜ì—ˆìŠµë‹ˆë‹¤. ëª‡ ë¶„ ë‚´ë¡œ ë°˜ì˜ë©ë‹ˆë‹¤ã€‚", ephemeral=True)


    # --- ëª…ë ¹ì–´ í™œì„±í™”/ë¹„í™œì„±í™” ê·¸ë£¹ ---
    command_toggle_group = app_commands.Group(name="ëª…ë ¹ì–´", description="ì´ ì„œë²„ì˜ ëª…ë ¹ì–´ í™œì„±í™” ìƒíƒœë¥¼ ê´€ë¦¬í•©ë‹ˆë‹¤ã€‚", guild_only=True)

    @command_toggle_group.command(name="í™œì„±í™”", description="ì´ ì„œë²„ì—ì„œ íŠ¹ì • ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ í™œì„±í™”í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì»¤ë§¨ë“œ="í™œì„±í™”í•  ëª…ë ¹ì–´ (ì˜ˆ: ì”ì•¡, ì°¨ëŸ‰ë“±ë¡)")
    @app_commands.check(_is_server_manager_check)
    async def enable_command(self, interaction: discord.Interaction, ì»¤ë§¨ë“œ: str):
        self.set_command_enabled_state(interaction.guild.id, ì»¤ë§¨ë“œ, True)
        await interaction.response.send_message(f"âœ… ëª…ë ¹ì–´ `ì €ìŠ¤íŠ¸ {ì»¤ë§¨ë“œ}`ê°€ ì´ ì„œë²„ì—ì„œ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤ã€‚", ephemeral=True)

    @command_toggle_group.command(name="ë¹„í™œì„±í™”", description="ì´ ì„œë²„ì—ì„œ íŠ¹ì • ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ ë¹„í™œì„±í™”í•©ë‹ˆë‹¤.")
    @app_commands.describe(ì»¤ë§¨ë“œ="ë¹„í™œì„±í™”í•  ëª…ë ¹ì–´ (ì˜ˆ: ì”ì•¡, ì°¨ëŸ‰ë“±ë¡)")
    @app_commands.check(_is_server_manager_check)
    async def disable_command(self, interaction: discord.Interaction, ì»¤ë§¨ë“œ: str):
        self.set_command_enabled_state(interaction.guild.id, ì»¤ë§¨ë“œ, False)
        await interaction.response.send_message(f"âŒ ëª…ë ¹ì–´ `ì €ìŠ¤íŠ¸ {ì»¤ë§¨ë“œ}`ê°€ ì´ ì„œë²„ì—ì„œ ë¹„í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤ã€‚", ephemeral=True)

    @command_toggle_group.command(name="ìƒíƒœí™•ì¸", description="ì´ ì„œë²„ì˜ ëª¨ë“  ëª…ë ¹ì–´ í™œì„±í™” ìƒíƒœë¥¼ í™•ì¸í•©ë‹ˆë‹¤.")
    @app_commands.check(_is_server_manager_check)
    async def check_command_states(self, interaction: discord.Interaction):
        conn = self.get_db_connection()
        cursor = conn.cursor()
        cursor.execute("SELECT command_name, is_enabled FROM server_command_states WHERE guild_id = ?", (str(interaction.guild.id),))
        states = cursor.fetchall()
        conn.close()

        status_message = "--- ëª…ë ¹ì–´ í™œì„±í™” ìƒíƒœ ---\n"
        if not states:
            status_message += "ëª¨ë“  ëª…ë ¹ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (ë³„ë„ ì„¤ì • ì—†ìŒ).\n"
        else:
            for state in states:
                status = "í™œì„±í™”ë¨ âœ…" if state['is_enabled'] == 1 else "ë¹„í™œì„±í™”ë¨ âŒ"
                status_message += f"**ì €ìŠ¤íŠ¸ {state['command_name']}**: {status}\n"

        embed = discord.Embed(
            title=f"{interaction.guild.name} ì„œë²„ì˜ ëª…ë ¹ì–´ ìƒíƒœ",
            description=status_message,
            color=discord.Color.light_grey()
        )
        await interaction.response.send_message(embed=embed, ephemeral=True)

    # --- ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ (ëª¨ë”ë ˆì´ì…˜) ---
    @app_commands.command(name="í‚¥", description="ìœ ì €ë¥¼ ì„œë²„ì—ì„œ ê°•í‡´ì‹œí‚µë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ê°•í‡´í•  ìœ ì €", ì‚¬ìœ ="ê°•í‡´ ì‚¬ìœ ")
    @app_commands.check(_is_server_manager_check)
    async def kick_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._kick_user(ìœ ì €, ì‚¬ìœ , interaction=interaction)

    @app_commands.command(name="ë°´", description="ìœ ì €ë¥¼ ì„œë²„ì—ì„œ ì¶”ë°©ì‹œí‚µë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ì¶”ë°©í•  ìœ ì €", ì‚¬ìœ ="ì¶”ë°© ì‚¬ìœ ", ì¼ìˆ˜="ë©”ì‹œì§€ ì‚­ì œ ì¼ìˆ˜ (ìµœëŒ€ 7ì¼)")
    @app_commands.check(_is_server_manager_check)
    async def ban_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ", ì¼ìˆ˜: app_commands.Range[int, 0, 7] = 0):
        await self._ban_user(ìœ ì €, ì‚¬ìœ , ì¼ìˆ˜, interaction=interaction)

    @app_commands.command(name="ì²­ì†Œ", description="ì±„ë„ì˜ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.")
    @app_commands.describe(ê°œìˆ˜="ì‚­ì œí•  ë©”ì‹œì§€ ê°œìˆ˜ (ìµœëŒ€ 100ê°œ)")
    @app_commands.check(_is_server_manager_check)
    async def clear_slash(self, interaction: discord.Interaction, ê°œìˆ˜: app_commands.Range[int, 1, 100]):
        await self._clear_messages(ê°œìˆ˜, interaction=interaction)

    @app_commands.command(name="ì—­í• ë¶€ì—¬", description="ìœ ì €ì—ê²Œ ì—­í• ì„ ë¶€ì—¬í•©ë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ì—­í• ì„ ë¶€ì—¬í•  ìœ ì €", ì—­í• ="ë¶€ì—¬í•  ì—­í• ")
    @app_commands.check(_is_server_manager_check)
    async def add_role_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì—­í• : discord.Role):
        await self._manage_role(ìœ ì €, ì—­í• , 'add', interaction=interaction)

    @app_commands.command(name="ì—­í• ì‚­ì œ", description="ìœ ì €ì˜ ì—­í• ì„ ì‚­ì œí•©ë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ì—­í• ì„ ì‚­ì œí•  ìœ ì €", ì—­í• ="ì‚­ì œí•  ì—­í• ")
    @app_commands.check(_is_server_manager_check)
    async def remove_role_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì—­í• : discord.Role):
        await self._manage_role(ìœ ì €, ì—­í• , 'remove', interaction=interaction)

    @app_commands.command(name="ê²½ê³ ", description="ìœ ì €ì—ê²Œ ê²½ê³ ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ê²½ê³ ë¥¼ ì¤„ ìœ ì €", ì‚¬ìœ ="ê²½ê³  ì‚¬ìœ ")
    @app_commands.check(_is_server_manager_check)
    async def warn_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._warn_user(ìœ ì €, ì‚¬ìœ , interaction=interaction)

    @app_commands.command(name="ê²½ê³ ì¡°íšŒ", description="ìœ ì €ì˜ ê²½ê³  ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ê²½ê³  ë‚´ì—­ì„ ì¡°íšŒí•  ìœ ì €")
    @app_commands.check(_is_server_manager_check)
    async def check_warnings_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member):
        await self._check_warnings(ìœ ì €, interaction=interaction)

    @app_commands.command(name="ê²½ê³ ì‚­ì œ", description="ìœ ì €ì˜ ê²½ê³ ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤.")
    @app_commands.describe(ìœ ì €="ê²½ê³ ë¥¼ ì‚­ì œí•  ìœ ì €", ì¸ë±ìŠ¤="ì‚­ì œí•  ê²½ê³ ì˜ ë²ˆí˜¸ (ëª¨ë‘ ì‚­ì œí•˜ë ¤ë©´ 'ëª¨ë‘')", ì‚¬ìœ ="ê²½ê³  ì‚­ì œ ì‚¬ìœ ")
    @app_commands.check(_is_server_manager_check)
    async def remove_warning_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member, ì¸ë±ìŠ¤: str, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._remove_warning(ìœ ì €, ì¸ë±ìŠ¤, ì‚¬ìœ , interaction=interaction)

    # --- í‹°ì¼“ ëª…ë ¹ì–´ ê·¸ë£¹ ---
    ticket_group = app_commands.Group(name="í‹°ì¼“", description="ê³ ê° ì§€ì› í‹°ì¼“ì„ ê´€ë¦¬í•©ë‹ˆë‹¤.", guild_only=True)

    @ticket_group.command(name="ì˜¤í”ˆ", description="ìƒˆë¡œìš´ ê³ ê° ì§€ì› í‹°ì¼“ì„ ì—½ë‹ˆë‹¤.")
    @app_commands.describe(ì‚¬ìœ ="í‹°ì¼“ì„ ì—¬ëŠ” ì´ìœ ")
    @app_commands.guild_only()
    async def open_ticket_slash(self, interaction: discord.Interaction, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._open_ticket(interaction.user, interaction.guild, interaction.channel, ì‚¬ìœ , interaction=interaction)

    @ticket_group.command(name="ë‹«ê¸°", description="í˜„ì¬ ì±„ë„ì˜ í‹°ì¼“ì„ ë‹«ìŠµë‹ˆë‹¤.")
    @app_commands.describe(ì‚¬ìœ ="í‹°ì¼“ì„ ë‹«ëŠ” ì´ìœ ")
    @app_commands.guild_only()
    @app_commands.check(_is_server_manager_check)
    async def close_ticket_slash(self, interaction: discord.Interaction, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._close_ticket(interaction.user, interaction.channel, ì‚¬ìœ , interaction=interaction)

    @app_commands.command(name="ë´‡ìƒíƒœ", description=f"í˜„ì¬ {bot_name}ì˜ ìƒíƒœì™€ í™œë™ì„ í™•ì¸í•©ë‹ˆë‹¤ã€‚") # ğŸš© ì´ë¦„ ë³€ê²½
    @app_commands.guild_only()
    async def show_bot_status_slash(self, interaction: discord.Interaction):
        await self._show_bot_status(interaction.user, interaction.channel, interaction=interaction)

    @app_commands.command(name="ìŠ¤ìº”ë¸”ë™ë¦¬ìŠ¤íŠ¸", description="ê¸€ë¡œë²Œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ëœ ì•…ì„± ìœ ì €ì¸ì§€ ìŠ¤ìº”í•©ë‹ˆë‹¤ã€‚")
    @app_commands.describe(ìœ ì €="ìŠ¤ìº”í•  ìœ ì €ë¥¼ ë©˜ì…˜í•˜ì„¸ìš”ã€‚")
    @app_commands.guild_only()
    @app_commands.check(_is_server_manager_check)
    async def scan_blacklist_slash(self, interaction: discord.Interaction, ìœ ì €: discord.Member):
        await self._scan_blacklist_user(ìœ ì €, interaction=interaction)

    @app_commands.command(name="ë³´ì•ˆë¦¬í¬íŠ¸", description="ì´ ì„œë²„ì˜ ë³´ì•ˆ ì„¤ì • ìƒíƒœì— ëŒ€í•œ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤ã€‚")
    @app_commands.guild_only()
    @app_commands.check(_is_server_manager_check)
    async def security_report_slash(self, interaction: discord.Interaction):
        await self._security_report(interaction=interaction)

    @app_commands.command(name="ëª…ë ¹ì–´ë¦¬ìŠ¤íŠ¸", description="ì´ ì±„ë„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤ã€‚")
    @app_commands.guild_only()
    async def command_list_slash(self, interaction: discord.Interaction):
        await self._list_commands_report(interaction.guild, interaction.channel, interaction=interaction)

    # ğŸš© ë³µêµ¬ ë´‡ - ìŠ¤ëƒ…ìƒ· ìƒì„±/ë³µêµ¬ ëª…ë ¹ì–´ ì¶”ê°€
    @recovery_group.command(name="ìƒì„±", description="í˜„ì¬ ì„œë²„ì˜ ìŠ¤ëƒ…ìƒ·ì„ ìƒì„±í•˜ì—¬ ë°±ì—…í•©ë‹ˆë‹¤ã€‚")
    @app_commands.guild_only()
    @app_commands.check(_is_server_manager_check)
    async def create_snapshot_slash(self, interaction: discord.Interaction):
        await self._create_server_snapshot(interaction.guild, interaction=interaction)

    @recovery_group.command(name="ë³µêµ¬", description="ìµœê·¼ ì €ì¥ëœ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì„œë²„ë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤ã€‚")
    @app_commands.guild_only()
    @app_commands.check(_is_server_manager_check)
    async def restore_snapshot_slash(self, interaction: discord.Interaction):
        await self._restore_server_snapshot(interaction.guild, interaction=interaction)


    # --- ë©”ì‹œì§€ ê¸°ë°˜ ëª…ë ¹ì–´ ---
    @commands.command(name="í‚¥", help=f"ìœ ì €ë¥¼ ì„œë²„ì—ì„œ ê°•í‡´ì‹œí‚µë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ í‚¥ @ìœ ì € ì‚¬ìœ )")
    @commands.check(_is_server_manager_msg_check)
    async def kick_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, *, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._kick_user(ìœ ì €, ì‚¬ìœ , ctx=ctx)

    @commands.command(name="ë°´", help=f"ìœ ì €ë¥¼ ì„œë²„ì—ì„œ ì¶”ë°©ì‹œí‚µë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ë°´ @ìœ ì € ì‚¬ìœ )")
    @commands.check(_is_server_manager_msg_check)
    async def ban_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, *, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._ban_user(ìœ ì €, ì‚¬ìœ , 0, ctx=ctx)

    @commands.command(name="ì²­ì†Œ", help=f"ì±„ë„ì˜ ë©”ì‹œì§€ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ì²­ì†Œ 10)")
    @commands.check(_is_server_manager_msg_check)
    async def clear_msg(self, ctx: commands.Context, ê°œìˆ˜: int):
        await self._clear_messages(ê°œìˆ˜, ctx=ctx)

    @commands.command(name="ì—­í• ë¶€ì—¬", help=f"ìœ ì €ì—ê²Œ ì—­í• ì„ ë¶€ì—¬í•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ì—­í• ë¶€ì—¬ @ìœ ì € @ì—­í• )")
    @commands.check(_is_server_manager_msg_check)
    async def add_role_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, ì—­í• : discord.Role):
        await self._manage_role(ìœ ì €, ì—­í• , 'add', ctx=ctx)

    @commands.command(name="ì—­í• ì‚­ì œ", help=f"ìœ ì €ì˜ ì—­í• ì„ ì‚­ì œí•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ì—­í• ì‚­ì œ @ìœ ì € @ì—­í• )")
    @commands.check(_is_server_manager_msg_check)
    async def remove_role_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, ì—­í• : discord.Role):
        await self._manage_role(ìœ ì €, ì—­í• , 'remove', ctx=ctx)

    @commands.command(name="ê²½ê³ ", help=f"ìœ ì €ì—ê²Œ ê²½ê³ ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ê²½ê³  @ìœ ì € ì‚¬ìœ )")
    @commands.check(_is_server_manager_msg_check)
    async def warn_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, *, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._warn_user(ìœ ì €, ì‚¬ìœ , ctx=ctx)

    @commands.command(name="ê²½ê³ ì¡°íšŒ", help=f"ìœ ì €ì˜ ê²½ê³  ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ê²½ê³ ì¡°íšŒ @ìœ ì €)")
    @commands.check(_is_server_manager_msg_check)
    async def check_warnings_msg(self, ctx: commands.Context, ìœ ì €: discord.Member):
        await self._check_warnings(ìœ ì €, ctx=ctx)

    @commands.command(name="ê²½ê³ ì‚­ì œ", help=f"ìœ ì €ì˜ ê²½ê³ ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ê²½ê³ ì‚­ì œ @ìœ ì € 1 ì‚¬ìœ  / ì €ìŠ¤íŠ¸ ê²½ê³ ì‚­ì œ @ìœ ì € ëª¨ë‘ ì‚¬ìœ )")
    @commands.check(_is_server_manager_msg_check)
    async def remove_warning_msg(self, ctx: commands.Context, ìœ ì €: discord.Member, ì¸ë±ìŠ¤: str, *, ì‚¬ìœ : str = "ì‚¬ìœ  ì—†ìŒ"):
        await self._remove_warning(ìœ ì €, ì¸ë±ìŠ¤, ì‚¬ìœ , ctx=ctx)

    @commands.command(name="ë´‡ìƒíƒœ", help=f"í˜„ì¬ {bot_name}ì˜ ìƒíƒœì™€ í™œë™ì„ í™•ì¸í•©ë‹ˆë‹¤ã€‚ (ì˜ˆ: ì €ìŠ¤íŠ¸ ë´‡ìƒíƒœ)") # ğŸš© ì´ë¦„ ë³€ê²½
    async def show_bot_status_msg(self, ctx: commands.Context):
        await self._show_bot_status(ctx.author, ctx.channel, ctx=ctx)

    @commands.command(name="ìŠ¤ìº”ë¸”ë™ë¦¬ìŠ¤íŠ¸", help=f"ê¸€ë¡œë²Œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ëœ ì•…ì„± ìœ ì €ì¸ì§€ ìŠ¤ìº”í•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ìŠ¤ìº”ë¸”ë™ë¦¬ìŠ¤íŠ¸ @ìœ ì €)")
    @commands.check(_is_server_manager_msg_check)
    async def scan_blacklist_msg(self, ctx: commands.Context, ìœ ì €: discord.Member):
        await self._scan_blacklist_user(ìœ ì €, ctx=ctx)

    @commands.command(name="ë³´ì•ˆë¦¬í¬íŠ¸", help=f"ì´ ì„œë²„ì˜ ë³´ì•ˆ ì„¤ì • ìƒíƒœì— ëŒ€í•œ ë¦¬í¬íŠ¸ë¥¼ ì œê³µí•©ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ë³´ì•ˆë¦¬í¬íŠ¸)")
    @commands.check(_is_server_manager_msg_check)
    async def security_report_msg(self, ctx: commands.Context):
        await self._security_report(ctx=ctx)

    @commands.command(name="ëª…ë ¹ì–´ë¦¬ìŠ¤íŠ¸", help=f"ì´ ì±„ë„ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª…ë ¹ì–´ ëª©ë¡ì„ ë³´ì—¬ì¤ë‹ˆë‹¤. (ì˜ˆ: ì €ìŠ¤íŠ¸ ëª…ë ¹ì–´ë¦¬ìŠ¤íŠ¸)")
    async def command_list_msg(self, ctx: commands.Context):
        if not ctx.guild:
            await ctx.send("ì´ ëª…ë ¹ì–´ëŠ” ì„œë²„ì—ì„œë§Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
            return
        await self._list_commands_report(ctx.guild, ctx.channel, ctx=ctx)

    @commands.command(name="ìŠ¤ëƒ…ìƒ·ìƒì„±", help=f"í˜„ì¬ ì„œë²„ì˜ ìŠ¤ëƒ…ìƒ·ì„ ìƒì„±í•˜ì—¬ ë°±ì—…í•©ë‹ˆë‹¤ã€‚")
    @commands.check(_is_server_manager_msg_check)
    async def create_snapshot_msg(self, ctx: commands.Context):
        await self._create_server_snapshot(ctx.guild, ctx=ctx)

    @commands.command(name="ìŠ¤ëƒ…ìƒ·ë³µêµ¬", help=f"ìµœê·¼ ì €ì¥ëœ ìŠ¤ëƒ…ìƒ·ìœ¼ë¡œ ì„œë²„ë¥¼ ë³µêµ¬í•©ë‹ˆë‹¤ã€‚")
    @commands.check(_is_server_manager_msg_check)
    async def restore_snapshot_msg(self, ctx: commands.Context):
        await self._restore_server_snapshot(ctx.guild, ctx=ctx)

    # --- ë©”ì‹œì§€ ë¦¬ìŠ¤ë„ˆ (ë³´ì•ˆ í•„í„°) ---
    @commands.Cog.listener()
    async def on_message(self, message: discord.Message):
        if message.author.bot or not message.guild:
            return

        await self._process_security_filters(message)
"""

```python
# ğŸš© (ê³„ì†) ... /cogs/moderation.py
    # --- ë‚´ë¶€ í•¨ìˆ˜ë“¤ (ìŠ¬ë˜ì‹œ ë° ë©”ì‹œì§€ ê¸°ë°˜ ëª…ë ¹ì–´ì—ì„œ ê³µí†µ ì‚¬ìš©) ---

    async def _kick_user(self, ìœ ì €: discord.Member, ì‚¬ìœ : str, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
        target_guild = interaction.guild if interaction else ctx.guild
        target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
        # ê¶Œí•œ ì²´í¬ëŠ” ì´ë¯¸ ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰ (ì—¬ê¸°ëŠ” ìˆœìˆ˜ ë¡œì§ë§Œ)

        if ìœ ì €.bot:
            response_msg = "âŒ ë´‡ì—ê²ŒëŠ” í‚¥ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        if ìœ ì €.top_role >= target_guild.me.top_role:
            response_msg = "âŒ ì €ë³´ë‹¤ ë†’ì€ ì—­í• ì˜ ìœ ì €ëŠ” í‚¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        caller_member = interaction.user if interaction else ctx.author
        if ìœ ì €.top_role >= caller_member.top_role and not caller_member.guild_permissions.administrator:
            response_msg = "âŒ ë‹¹ì‹ ë³´ë‹¤ ë†’ì€ ì—­í• ì˜ ìœ ì €ëŠ” í‚¥í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        try:
            if interaction and not interaction.response.is_done(): await interaction.response.defer(ephemeral=False)
            await ìœ ì €.kick(reason=ì‚¬ìœ )
            response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì„ ê°•í‡´í–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }"
            if interaction: await interaction.followup.send(response_msg)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

            try: await ìœ ì €.send(f"ğŸš¨ ë‹¹ì‹ ì€ {target_guild.name} ì„œë²„ì—ì„œ ê°•í‡´ë‹¹í–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }")
            except discord.Forbidden: print(f"ìœ ì € {ìœ ì €.display_name}ì—ê²Œ DMì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        except discord.Forbidden:
            response_msg = "âŒ ë´‡ì—ê²Œ ê°•í‡´ ê¶Œí•œì´ ì—†ê±°ë‚˜, ëŒ€ìƒ ìœ ì €ì˜ ì—­í• ì´ ë´‡ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤ã€‚"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
        except Exception as e:
            response_msg = f"âŒ í‚¥ ì‹¤íŒ¨: {e}"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

    async def _ban_user(self, ìœ ì €: discord.Member, ì‚¬ìœ : str, ì¼ìˆ˜: int = 0, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
        target_guild = interaction.guild if interaction else ctx.guild
        target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
        caller_obj = interaction if interaction else ctx.author

        if ìœ ì €.bot:
            response_msg = "âŒ ë´‡ì—ê²ŒëŠ” ë°´ì„ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        if ìœ ì €.top_role >= target_guild.me.top_role:
            response_msg = "âŒ ì €ë³´ë‹¤ ë†’ì€ ì—­í• ì˜ ìœ ì €ëŠ” ë°´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        caller_member = interaction.user if interaction else ctx.author
        if ìœ ì €.top_role >= caller_member.top_role and not caller_member.guild_permissions.administrator:
            response_msg = "âŒ ë‹¹ì‹ ë³´ë‹¤ ë†’ì€ ì—­í• ì˜ ìœ ì €ëŠ” ë°´í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        try:
            if interaction and not interaction.response.is_done(): await interaction.response.defer(ephemeral=False)
            await ìœ ì €.ban(reason=ì‚¬ìœ , delete_message_days=ì¼ìˆ˜)
            response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì„ ì¶”ë°©í–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }, ë©”ì‹œì§€ ì‚­ì œ ì¼ìˆ˜: {ì¼ìˆ˜}ì¼"
            if interaction: await interaction.followup.send(response_msg)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            try: await ìœ ì €.send(f"ğŸš¨ ë‹¹ì‹ ì€ {target_guild.name} ì„œë²„ì—ì„œ ì¶”ë°©ë‹¹í–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }")
            except discord.Forbidden: print(f"ìœ ì € {ìœ ì €.display_name}ì—ê²Œ DMì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        except discord.Forbidden:
            response_msg = "âŒ ë´‡ì—ê²Œ ì¶”ë°© ê¶Œí•œì´ ì—†ê±°ë‚˜, ëŒ€ìƒ ìœ ì €ì˜ ì—­í• ì´ ë´‡ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤ã€‚"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
        except Exception as e:
            response_msg = f"âŒ ë°´ ì‹¤íŒ¨: {e}"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

    async def _clear_messages(self, ê°œìˆ˜: int, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
        target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
        # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

        try:
            if interaction and not interaction.response.is_done(): await interaction.response.defer(ephemeral=True)
            deleted = await target_channel.purge(limit=ê°œìˆ˜)
            response_msg = f"âœ… ë©”ì‹œì§€ {len(deleted)}ê°œë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤ã€‚"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
        except discord.Forbidden:
            response_msg = "âŒ ë´‡ì—ê²Œ ë©”ì‹œì§€ ê´€ë¦¬ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤ã€‚"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
        except Exception as e:
            response_msg = f"âŒ ì²­ì†Œ ì‹¤íŒ¨: {e}"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

    async def _manage_role(self, ìœ ì €: discord.Member, ì—­í• : discord.Role, action: str, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
        target_guild = interaction.guild if interaction else ctx.guild
        target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
        # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

        if ì—­í•  >= target_guild.me.top_role:
            response_msg = "âŒ ì €ë³´ë‹¤ ë†’ì€ ì—­í• ì€ ë¶€ì—¬/ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        caller_member = interaction.user if interaction else ctx.author
        if ìœ ì €.top_role >= caller_member.top_role and not caller_member.guild_permissions.administrator:
            response_msg = "âŒ ë‹¹ì‹ ë³´ë‹¤ ë†’ì€ ì—­í• ì€ ë¶€ì—¬/ì‚­ì œí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
            if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
            return

        try:
            if interaction and not interaction.response.is_done(): await interaction.response.defer(ephemeral=False)
            if action == 'add':
                await ìœ ì €.add_roles(ì—­í• )
                response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì—ê²Œ '{ì—­í• .name}' ì—­í• ì„ ë¶€ì—¬í–ˆìŠµë‹ˆë‹¤ã€‚"
            else:
                await ìœ ì €.remove_roles(ì—­í• )
                response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì—ê²Œì„œ '{ì—­í• .name}' ì—­í• ì„ ì‚­ì œí–ˆìŠµë‹ˆë‹¤ã€‚"

            if interaction: await interaction.followup.send(response_msg)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

        except discord.Forbidden:
            response_msg = "âŒ ë´‡ì—ê²Œ ì—­í•  ê´€ë¦¬ ê¶Œí•œì´ ì—†ê±°ë‚˜, ëŒ€ìƒ ì—­í• ì˜ ìœ„ì¹˜ê°€ ë´‡ë³´ë‹¤ ë†’ìŠµë‹ˆë‹¤ã€‚"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)
        except Exception as e:
            response_msg = f"âŒ ì—­í•  ê´€ë¦¬ ì‹¤íŒ¨: {e}"
            if interaction: await interaction.followup.send(response_msg, ephemeral=True)
            elif ctx: await ctx.send(response_msg)
            elif channel_to_send: await channel_to_send.send(response_msg)

async def _warn_user(self, ìœ ì €: discord.Member, ì‚¬ìœ : str, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
    """ìœ ì €ì—ê²Œ ê²½ê³ ë¥¼ ë¶€ì—¬í•©ë‹ˆë‹¤."""
    target_guild = interaction.guild if interaction else ctx.guild
    target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
    # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

    if ìœ ì €.bot:
        response_msg = "âŒ ë´‡ì—ê²ŒëŠ” ê²½ê³ ë¥¼ ì¤„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
        return

    if ìœ ì €.id == (interaction.user.id if interaction else ctx.author.id):
        response_msg = "âŒ ìê¸° ìì‹ ì—ê²Œ ê²½ê³ ë¥¼ ì¤„ ìˆœ ì—†ìŠµë‹ˆë‹¤!"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
        return

    caller_member = interaction.user if interaction else ctx.author
    if ìœ ì €.top_role >= caller_member.top_role and not caller_member.guild_permissions.administrator:
        response_msg = "âŒ ë‹¹ì‹ ë³´ë‹¤ ë†’ì€ ì—­í• ì˜ ìœ ì €ëŠ” ê²½ê³ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤!"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
        return

    conn = self.get_db_connection()
    cursor = conn.cursor()
    user_id_str = str(ìœ ì €.id)

    cursor.execute(\"\"\"
        INSERT INTO user_warnings (user_id, username, reason, moderator_id, moderator_name, timestamp)
        VALUES (?, ?, ?, ?, ?, ?)
    \"\"\", (user_id_str, ìœ ì €.display_name, ì‚¬ìœ , str(caller_member.id), caller_member.display_name, datetime.datetime.now(datetime.UTC).isoformat()))
    conn.commit()

    cursor.execute("SELECT COUNT(*) FROM user_warnings WHERE user_id = ?", (user_id_str,))
    warning_count = cursor.fetchone()[0]
    conn.close()

    warn_embed = discord.Embed(
        title="ğŸš¨ ê²½ê³  ì•Œë¦¼",
        description=f"{ìœ ì €.mention}ë‹˜ì´ ê²½ê³ ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤.",
        color=discord.Color.red()
    )
    warn_embed.add_field(name="ì‚¬ìœ ", value=ì‚¬ìœ , inline=False)
    warn_embed.add_field(name="ê²½ê³  íšŸìˆ˜", value=f"ì´ **{warning_count}íšŒ**", inline=False)
    warn_embed.set_footer(text=f"ê´€ë¦¬ì: {caller_member.display_name}")

    if interaction and not interaction.response.is_done(): await interaction.response.send_message(embed=warn_embed)
    elif ctx: await ctx.send(embed=warn_embed)
    try:
        await ìœ ì €.send(f"ğŸš¨ ë‹¹ì‹ ì€ {target_guild.name} ì„œë²„ì—ì„œ ê²½ê³ ë¥¼ ë°›ì•˜ìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }\nì´ ê²½ê³  íšŸìˆ˜: {warning_count}íšŒ")
    except discord.Forbidden:
        print(f"ìœ ì € {ìœ ì €.display_name}ì—ê²Œ DMì„ ë³´ë‚¼ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")

    server_config = self.bot.get_server_config(target_guild.id)
    auto_kick_warn_count = server_config.get('auto_kick_warn_count', 5)

    if warning_count >= auto_kick_warn_count:
        try:
            await ìœ ì €.kick(reason=f"ê²½ê³  {auto_kick_warn_count}íšŒ ëˆ„ì ìœ¼ë¡œ ìë™ ê°•í‡´")
            if target_channel: await target_channel.send(f"âš ï¸ {ìœ ì €.mention}ë‹˜ì´ ê²½ê³  ëˆ„ì ({auto_kick_warn_count}íšŒ)ìœ¼ë¡œ ì„œë²„ì—ì„œ ìë™ ê°•í‡´ë˜ì—ˆìŠµë‹ˆë‹¤.")
        except discord.Forbidden:
            if target_channel: await target_channel.send(f"âš ï¸ {ìœ ì €.mention}ë‹˜ì´ ê²½ê³  ëˆ„ì ({auto_kick_warn_count}íšŒ)ìœ¼ë¡œ ìë™ ê°•í‡´ ëŒ€ìƒì´ì§€ë§Œ, ë´‡ì˜ ê¶Œí•œ ë¶€ì¡±ìœ¼ë¡œ ê°•í‡´í•˜ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.")
        except Exception as e:
            print(f"ìë™ ê°•í‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
            if target_channel: await target_channel.send(f"âš ï¸ {ìœ ì €.mention}ë‹˜ ìë™ ê°•í‡´ ì²˜ë¦¬ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")


async def _check_warnings(self, ìœ ì €: discord.Member, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
    """ìœ ì €ì˜ ê²½ê³  ë‚´ì—­ì„ ì¡°íšŒí•©ë‹ˆë‹¤."""
    target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
    # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

    conn = self.get_db_connection()
    cursor = conn.cursor()
    user_id_str = str(ìœ ì €.id)
    cursor.execute("SELECT reason, moderator_name, timestamp FROM user_warnings WHERE user_id = ? ORDER BY timestamp ASC LIMIT 10", (user_id_str,))
    warnings = cursor.fetchall()
    conn.close()

    if not warnings:
        response_msg = f"âŒ {ìœ ì €.display_name}ë‹˜ì€ ê²½ê³  ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤!"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
        return

    warn_list_str = ""
    for i, w in enumerate(warnings):
        warn_time = datetime.datetime.fromisoformat(w['timestamp']).strftime('%Y-%m-%d')
        warn_list_str += f"{i+1}. ì‚¬ìœ : {w['reason']} (ê´€ë¦¬ì: {w['moderator_name']}, ë‚ ì§œ: {warn_time})\n"

    embed = discord.Embed(
        title=f"âš ï¸ {ìœ ì €.display_name}ë‹˜ì˜ ê²½ê³  ë‚´ì—­ (ì´ {len(warnings)}íšŒ)",
        description=warn_list_str,
        color=discord.Color.orange()
    )
    if interaction and not interaction.response.is_done(): await interaction.response.send_message(embed=embed, ephemeral=True)
    elif ctx: await ctx.send(embed=embed)
    elif channel_to_send: await channel_to_send.send(embed=embed)

async def _remove_warning(self, ìœ ì €: discord.Member, ì¸ë±ìŠ¤: str, ì‚¬ìœ : str, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
    """ìœ ì €ì˜ ê²½ê³ ë¥¼ ì‚­ì œí•©ë‹ˆë‹¤."""
    target_guild = interaction.guild if interaction else ctx.guild
    target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
    # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

    conn = self.get_db_connection()
    cursor = conn.cursor()
    user_id_str = str(ìœ ì €.id)

    if ì¸ë±ìŠ¤.lower() == "ëª¨ë‘":
        cursor.execute("DELETE FROM user_warnings WHERE user_id = ?", (user_id_str,))
        conn.commit()
        conn.close()
        response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì˜ ëª¨ë“  ê²½ê³ ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }"
        if interaction: await interaction.response.send_message(response_msg)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
    else:
        try:
            idx = int(ì¸ë±ìŠ¤) - 1
            cursor.execute("SELECT id FROM user_warnings WHERE user_id = ? ORDER BY timestamp ASC LIMIT 1 OFFSET ?", (user_id_str, idx))
            warning_to_delete = cursor.fetchone()

            if warning_to_delete:
                cursor.execute("DELETE FROM user_warnings WHERE id = ?", (warning_to_delete['id'],))
                conn.commit()
                conn.close()
                response_msg = f"âœ… {ìœ ì €.display_name}ë‹˜ì˜ {idx+1}ë²ˆì§¸ ê²½ê³ ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }"
                if interaction: await interaction.response.send_message(response_msg)
                elif ctx: await ctx.send(response_msg)
                elif channel_to_send: await channel_to_send.send(response_msg)
            else:
                conn.close()
                response_msg = "âŒ ìœ íš¨í•˜ì§€ ì•Šì€ ê²½ê³  ë²ˆí˜¸ì…ë‹ˆë‹¤!"
                if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
                elif ctx: await ctx.send(response_msg)
                elif channel_to_send: await channel_to_send.send(response_msg)

async def _open_ticket(self, user: discord.User, guild: discord.Guild, current_channel: discord.TextChannel, ì‚¬ìœ : str, interaction: discord.Interaction = None, ctx: commands.Context = None):
    target_guild = guild

    server_config = self.bot.get_server_config(target_guild.id)
    if not server_config:
        response_msg = "âŒ ì´ ì„œë²„ì˜ ë´‡ ì„¤ì •ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ `/ì„¤ì •` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ í•„ìš”í•œ ì±„ë„ê³¼ ì—­í• ì„ ì„¤ì •í•´ë‹¬ë¼ê³  ìš”ì²­í•˜ì„¸ìš”ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    ticket_open_channel_id = server_config.get('ticket_open_channel_id')
    ticket_category_id = server_config.get('ticket_category_id')
    ticket_staff_role_id = server_config.get('ticket_staff_role_id')

    if not all([ticket_open_channel_id, ticket_category_id, ticket_staff_role_id]):
        response_msg = (
            "âŒ í‹°ì¼“ ê¸°ëŠ¥ì˜ í•„ìˆ˜ ì„¤ì •(í‹°ì¼“ ê°œì„¤ ì±„ë„, í‹°ì¼“ ì¹´í…Œê³ ë¦¬, í‹°ì¼“ ê´€ë¦¬ ì—­í• )ì´ ì™„ë£Œë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. "
            "ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì—¬ `/ì„¤ì •` ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•´ í•„ìš”í•œ ì±„ë„ê³¼ ì—­í• ì„ ì„¤ì •í•´ë‹¬ë¼ê³  ìš”ì²­í•˜ì„¸ìš”ã€‚"
        )
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    if str(current_channel.id) != ticket_open_channel_id:
        ticket_channel_obj = self.bot.get_channel(int(ticket_open_channel_id))
        response_msg = f"âŒ í‹°ì¼“ì€ {ticket_channel_obj.mention if ticket_channel_obj else 'ì„¤ì •ëœ í‹°ì¼“ ê°œì„¤ ì±„ë„'}ì—ì„œë§Œ ì—´ ìˆ˜ ìˆìŠµë‹ˆë‹¤ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    conn = self.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT channel_id FROM tickets WHERE user_id = ? AND status = 'open'", (str(user.id),))
    if cursor.fetchone():
        conn.close()
        response_msg = "âŒ ì´ë¯¸ ì—´ë ¤ìˆëŠ” í‹°ì¼“ì´ ìˆìŠµë‹ˆë‹¤. ë¨¼ì € ê¸°ì¡´ í‹°ì¼“ì„ ë‹«ì•„ì£¼ì„¸ìš”ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    overwrites = {
        target_guild.default_role: discord.PermissionOverwrite(read_messages=False),
        user: discord.PermissionOverwrite(read_messages=True, send_messages=True, embed_links=True),
        target_guild.me: discord.PermissionOverwrite(read_messages=True, send_messages=True, embed_links=True)
    }
    staff_role_obj = target_guild.get_role(int(ticket_staff_role_id))
    if staff_role_obj:
        overwrites[staff_role_obj] = discord.PermissionOverwrite(read_messages=True, send_messages=True, embed_links=True)

    category_obj = self.bot.get_channel(int(ticket_category_id))
    if not category_obj or not isinstance(category_obj, discord.CategoryChannel):
        response_msg = "âŒ ì„¤ì •ëœ í‹°ì¼“ ì¹´í…Œê³ ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    try:
        if interaction and not interaction.response.is_done(): await interaction.response.defer(ephemeral=True)
        ticket_channel_name = f"í‹°ì¼“-{user.name.lower().replace(' ', '-')}-{datetime.datetime.now(datetime.UTC).strftime('%m%d%H%M')}"
        channel = await target_guild.create_text_channel(
            ticket_channel_name,
            category=category_obj,
            overwrites=overwrites,
            topic=f"{user.name}ë‹˜ì´ ê°œì„¤í•œ í‹°ì¼“ì…ë‹ˆë‹¤. ì‚¬ìœ : {ì‚¬ìœ }"
        )

        cursor.execute(\"\"\"
            INSERT INTO tickets (user_id, username, guild_id, channel_id, status, reason, opened_at)
            VALUES (?, ?, ?, ?, ?, ?, ?)
        \"\"\", (str(user.id), user.display_name, str(target_guild.id), str(channel.id), "open", ì‚¬ìœ , datetime.datetime.now(datetime.UTC).isoformat()))
        ticket_id = cursor.lastrowid
        conn.commit()
        conn.close()

        ticket_embed = discord.Embed(
            title=f"ğŸ”’ í‹°ì¼“ #{ticket['id']}ì´(ê°€) ë‹«í˜”ìŠµë‹ˆë‹¤ã€‚",
            description=f"í‹°ì¼“ì´ {user.mention}ì— ì˜í•´ ë‹«í˜”ìŠµë‹ˆë‹¤ã€‚\n**ì‚¬ìœ :** {ì‚¬ìœ }",
            color=discord.Color.red()
        )
        embed.set_footer(text="ì´ ì±„ë„ì€ ì ì‹œ í›„ ìë™ìœ¼ë¡œ ì‚­ì œë©ë‹ˆë‹¤ã€‚")
        await target_channel.send(embed=embed)

        response_msg = f"âœ… í‹°ì¼“ì´ ì„±ê³µì ìœ¼ë¡œ ë‹«í˜”ìŠµë‹ˆë‹¤. ì±„ë„ì€ ì ì‹œ í›„ ì‚­ì œë©ë‹ˆë‹¤ã€‚"
        if interaction: await interaction.followup.send(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)

        await asyncio.sleep(5)
        await target_channel.delete(reason=f"í‹°ì¼“ #{ticket['id']} ë‹«í˜ã€‚")

    except discord.Forbidden:
        response_msg = "âŒ ì±„ë„ì„ ì‚­ì œí•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ë´‡ì˜ ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”ã€‚"
        if interaction: await interaction.followup.send(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
    except Exception as e:
        print(f"í‹°ì¼“ ë‹«ê¸° ì¤‘ ì˜¤ë¥˜ ë°œìƒ: {e}")
        response_msg = f"âŒ í‹°ì¼“ ë‹«ê¸° ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {e}"
        if interaction: await interaction.followup.send(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)

async def _show_bot_status(self, user: discord.User, channel: discord.TextChannel, interaction: discord.Interaction = None, ctx: commands.Context = None):
    if interaction: await interaction.response.defer(ephemeral=False)

    settings = self.bot.get_bot_presence_settings()
    if not settings:
        response_msg = "âŒ ë´‡ ìƒíƒœ ì„¤ì • ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ìì—ê²Œ ë¬¸ì˜í•˜ì„¸ìš”ã€‚"
        if interaction: await interaction.followup.send(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        return

    status_display_map = {
        'online': 'ğŸŸ¢ ì˜¨ë¼ì¸',
        'idle': 'ğŸŸ  ìë¦¬ ë¹„ì›€',
        'dnd': 'ğŸ”´ ë°©í•´ ê¸ˆì§€',
        'invisible': 'âš« ì˜¤í”„ë¼ì¸ í‘œì‹œ'
    }
    activity_type_map = {
        'playing': 'ğŸ® í”Œë ˆì´ ì¤‘',
        'streaming': 'ğŸ“º ìŠ¤íŠ¸ë¦¬ë° ì¤‘',
        'listening': 'ğŸ§ ë“£ëŠ” ì¤‘',
        'watching': 'ğŸ¬ ì‹œì²­ ì¤‘'
    }

    embed = discord.Embed(
        title=f"âœ¨ {self.bot.BOT_NAME} í˜„ì¬ ìƒíƒœ", # ğŸš© ì´ë¦„ ì‚¬ìš©
        description=f"í˜„ì¬ {self.bot.BOT_NAME}ì˜ ìƒíƒœì™€ í™œë™ ì •ë³´ì…ë‹ˆë‹¤ã€‚", # ğŸš© ì´ë¦„ ì‚¬ìš©
        color=discord.Color.blurple()
    )
    embed.add_field(name="ìƒíƒœ", value=status_display_map.get(settings['status'], 'ì•Œ ìˆ˜ ì—†ìŒ'), inline=False)
    embed.add_field(name="í™œë™", value=f"{activity_type_map.get(settings['activity_type'], 'ì•Œ ìˆ˜ ì—†ìŒ')}: {settings['activity_name']}", inline=False)
    embed.set_footer(text=f"ìµœì¢… ì—…ë°ì´íŠ¸: {datetime.datetime.now(datetime.UTC).strftime('%Y-%m-%d %H:%M:%S')} (UTC)")

    if interaction: await interaction.followup.send(embed=embed)
    elif ctx: await ctx.send(embed=embed)

async def _scan_blacklist_user(self, ìœ ì €: discord.Member, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
    target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
    # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

    conn = self.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT user_id, reason FROM global_blacklist WHERE user_id = ?", (str(ìœ ì €.id),))
    result = cursor.fetchone()
    conn.close()

    if result:
        response_msg = f"ğŸš¨ **{ìœ ì €.display_name}**ë‹˜ì€ ê¸€ë¡œë²Œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ë“±ë¡ëœ ì•…ì„± ìœ ì €ì…ë‹ˆë‹¤!\nì‚¬ìœ : {result['reason']}"
        embed = discord.Embed(
            title="âš ï¸ ë¸”ë™ë¦¬ìŠ¤íŠ¸ ìŠ¤ìº” ê²°ê³¼",
            description=response_msg,
            color=discord.Color.red()
        )
        if interaction: await interaction.response.send_message(embed=embed, ephemeral=False)
        elif ctx: await ctx.send(embed=embed)
        elif channel_to_send: await channel_to_send.send(embed=embed)
    else:
        response_msg = f"âœ… **{ìœ ì €.display_name}**ë‹˜ì€ ê¸€ë¡œë²Œ ë¸”ë™ë¦¬ìŠ¤íŠ¸ì— ì—†ìŠµë‹ˆë‹¤ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=False)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)

async def _security_report(self, interaction: discord.Interaction = None, ctx: commands.Context = None, channel_to_send=None):
    target_guild = interaction.guild if interaction else ctx.guild
    target_channel = interaction.channel if interaction else ctx.channel if ctx else channel_to_send
    # ê¶Œí•œ ì²´í¬ëŠ” ë°ì½”ë ˆì´í„°ì—ì„œ ìˆ˜í–‰

    server_config = self.bot.get_server_config(target_guild.id)
    if not server_config:
        response_msg = "âŒ ì´ ì„œë²„ì— ì €ì¥ëœ ë´‡ ë³´ì•ˆ ì„¤ì •ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ì„¤ì •ì´ ì ìš© ì¤‘ì¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤ã€‚"
        if interaction: await interaction.response.send_message(response_msg, ephemeral=True)
        elif ctx: await ctx.send(response_msg)
        elif channel_to_send: await channel_to_send.send(response_msg)
        return

    invite_filter_status = "í™œì„±í™” âœ…" if server_config.get('invite_filter_enabled', 0) == 1 else "ë¹„í™œì„±í™” âŒ"
    spam_filter_status = "í™œì„±í™” âœ…" if server_config.get('spam_filter_enabled', 0) == 1 else "ë¹„í™œì„±í™” âŒ"
    spam_threshold = server_config.get('spam_threshold', 5)
    spam_time_window = server_config.get('spam_time_window', 10)

    embed = discord.Embed(
        title=f"ğŸ›¡ï¸ {target_guild.name} ì„œë²„ ë³´ì•ˆ ë¦¬í¬íŠ¸",
        description=f"í˜„ì¬ ì„œë²„ì— ì ìš©ëœ {self.bot.BOT_NAME} ë³´ì•ˆ ì„¤ì •ì…ë‹ˆë‹¤ã€‚", # ğŸš© ë´‡ ì´ë¦„ ì‚¬ìš©
        color=discord.Color.dark_teal()
    )
    embed.add_field(name="ì´ˆëŒ€ ë§í¬ ê²€ì—´", value=invite_filter_status, inline=False)
    embed.add_field(name="ë„ë°° ê°ì§€", value=spam_filter_status, inline=False)
    if server_config.get('spam_filter_enabled', 0) == 1:
        embed.add_field(name="â”” ë„ë°° ê¸°ì¤€", value=f"{spam_threshold} ë©”ì‹œì§€/{spam_time_window}ì´ˆ", inline=False)

    conn = self.get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT COUNT(*) FROM user_warnings")
    total_warnings = cursor.fetchone()[0]
    embed.add_field(name="ëˆ„ì  ê²½ê³  ìˆ˜ (ë´‡ ì „ì²´)", value=f"ì´ {total_warnings}íšŒ", inline=False)
    conn.close()

    if interaction: await interaction.response.send_message(embed=embed, ephemeral=False)
    elif ctx: await ctx.send(embed=embed)
    elif channel_to_send: await channel_to_send.send(embed=embed)

async def _list_commands_report(self, guild: discord.Guild, channel: discord.TextChannel, interaction: discord.Interaction = None, ctx: commands.Context = None):
    if interaction: await interaction.response.defer(ephemeral=False)

    server_config = self.bot.get_server_config(guild.id)
    bank_channel_id = server_config.get('bank_channel_id')

    all_commands = []
    for cmd in self.bot.commands:
        all_commands.append(cmd.name)
    for cmd in self.bot.tree.walk_commands():
        all_commands.append(cmd.qualified_name)
    all_commands = sorted(list(set(all_commands)))

    commands_categorized = {
        "ì¼ë°˜ ëª…ë ¹ì–´": [],
        "ì€í–‰ ëª…ë ¹ì–´": [],
        "ì°¨ëŸ‰ ëª…ë ¹ì–´": [],
        "ê´€ë¦¬ ëª…ë ¹ì–´": [],
        "í‹°ì¼“ ëª…ë ¹ì–´": [],
        "ìŒì•… ëª…ë ¹ì–´": [],
        "ê²Œì„ ëª…ë ¹ì–´": [],
        "ë³´ì•ˆ ëª…ë ¹ì–´": [],
        "ì„¤ì • ëª…ë ¹ì–´": [],
        "ë³µêµ¬ ëª…ë ¹ì–´": []
    }

    for cmd_name in all_commands:
        is_enabled_in_settings = self.bot.is_command_enabled(guild.id, cmd_name)
        status_icon = "âœ…" if is_enabled_in_settings else "âŒ"

        slash_display = f"/{cmd_name}" if self.bot.tree.get_command(cmd_name) else ""
        msg_cmd_obj = self.bot.get_command(cmd_name)
        msg_display = f"{self.bot.command_prefix}{cmd_name}" if msg_cmd_obj else ""

        display_name = ""
        if slash_display and msg_display: display_name = f"{slash_display} | {msg_display}"
        elif slash_display: display_name = slash_display
        elif msg_display: display_name = msg_display
        else: continue

        command_info = {"name": display_name, "status": status_icon, "available_in_this_channel": True}

        if "ì€í–‰" in cmd_name or cmd_name in ["í†µì¥ê°œì„¤", "ì”ì•¡", "ì…ê¸ˆ", "ì¶œê¸ˆ", "ì†¡ê¸ˆ", "ëŒ€ì¶œ", "ìƒí™˜", "ê±°ë˜ë‚´ì—­"]:
            if bank_channel_id and str(channel.id) != bank_channel_id:
                command_info["available_in_this_channel"] = False
            commands_categorized["ì€í–‰ ëª…ë ¹ì–´"].append(command_info)
        elif "ì°¨ëŸ‰" in cmd_name or cmd_name in ["ì°¨ëŸ‰ë“±ë¡"]:
            commands_categorized["ì°¨ëŸ‰ ëª…ë ¹ì–´"].append(command_info)
        elif "í‚¥" in cmd_name or "ë°´" in cmd_name or "ì²­ì†Œ" in cmd_name or "ì—­í• " in cmd_name or "ê²½ê³ " in cmd_name:
            commands_categorized["ê´€ë¦¬ ëª…ë ¹ì–´"].append(command_info)
        elif "í‹°ì¼“" in cmd_name:
            commands_categorized["í‹°ì¼“ ëª…ë ¹ì–´"].append(command_info)
        elif "ë“¤ì–´ì™€" in cmd_name or "ë‚˜ê°€" in cmd_name or "ì¬ìƒ" in cmd_name or "ì •ì§€" in cmd_name:
            commands_categorized["ìŒì•… ëª…ë ¹ì–´"].append(command_info)
        elif "ì£¼ì‚¬ìœ„" in cmd_name or "ê°€ìœ„ë°”ìœ„ë³´" in cmd_name:
            commands_categorized["ê²Œì„ ëª…ë ¹ì–´"].append(command_info)
        elif "ìŠ¤ìº”ë¸”ë™ë¦¬ìŠ¤íŠ¸" in cmd_name or "ë³´ì•ˆë¦¬í¬íŠ¸" in cmd_name or "ì´ˆëŒ€ë§í¬ê²€ì—´" in cmd_name or "ë„ë°°ê°
