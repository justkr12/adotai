import os
import sys
import shutil

# --- 1. ìœ ì € ì…ë ¥ ë°›ê¸° ---
def get_user_inputs():
    print("--- opendiscordbot í”„ë¡œì íŠ¸ ìƒì„±ê¸° ---")
    print("ì´ ìŠ¤í¬ë¦½íŠ¸ëŠ” Discord ë´‡ì˜ ë‹¤ì–‘í•œ ë²„ì „ì„ ìƒì„±í•©ë‹ˆë‹¤.")
    print("ìƒì„±ëœ í”„ë¡œì íŠ¸ í´ë”ë¡œ ì´ë™í•˜ì—¬ '.env' íŒŒì¼ì„ ì—´ì–´ YOUR_...HERE ë¡œ ëœ ë¶€ë¶„ë“¤ì„ ë°˜ë“œì‹œ ì±„ì›Œì£¼ì„¸ìš”.")

    bot_name = input("1. ë´‡ì˜ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ê°’: opendiscordbot): ").strip() or "opendiscordbot"
    currency_name = input(f"2. {bot_name}ì—ì„œ ì‚¬ìš©í•  í™”í ë‹¨ìœ„ë¥¼ ì…ë ¥í•˜ì„¸ìš” (ê¸°ë³¸ê°’: ìœ„í‚¤ì›): ").strip() or "ìœ„í‚¤ì›"

    print("\n--- 3. ìƒì„±í•  ë´‡ì˜ ëŸ°íƒ€ì„ ì¢…ë¥˜ ì„ íƒ ---")
    print("1. Python Botë§Œ ìƒì„±")
    print("2. Node.js Botë§Œ ìƒì„±")
    print("3. Python Botê³¼ Node.js Bot ëª¨ë‘ ìƒì„±")
    bot_runtime_choice = input("ì„ íƒ (1/2/3): ").strip()

    try:
        bot_runtime_choice = int(bot_runtime_choice)
        if bot_runtime_choice not in [1, 2, 3]:
            raise ValueError
    except ValueError:
        print("âŒ ì˜ëª»ëœ ëŸ°íƒ€ì„ ì„ íƒì…ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        sys.exit(1)

    print("\n--- 4. ìƒì„±í•  í”„ë¡œì íŠ¸ ë²„ì „ ì„ íƒ ---")
    print("1. Version 1: [ì›ë³¸] ì›¹ ëŒ€ì‹œë³´ë“œ O (Flask), Anvil API O (ì´ë©”ì¼ ë´‡, API ì„œë²„), í™ˆí˜ì´ì§€, ìë™íšŒì‹  ì‹œìŠ¤í…œ")
    print("2. Version 2: [ëŒ€ì‹œë³´ë“œ X] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, Anvil API O (ì´ë©”ì¼ ë´‡, API ì„œë²„), ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    print("3. Version 3: [Anvil API X] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, Flask API (Wispbyte/SQLite), ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    print("4. Version 4: [ìˆœìˆ˜ ë´‡] ì›¹ ëŒ€ì‹œë³´ë“œ UI ì—†ìŒ, API ì—†ìŒ, ë¡œì»¬ SQLite DB, í•œ ê¸¸ë“œ ì „ìš©, ë´‡ ì†Œìœ ì ì „ìš© ê¸°ëŠ¥ ê°•í™”")
    version_choice = input("ë²„ì „ ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš” (1/2/3/4): ").strip()

    try:
        version_choice = int(version_choice)
        if version_choice not in [1, 2, 3, 4]:
            raise ValueError
    except ValueError:
        print("âŒ ì˜ëª»ëœ ë²„ì „ ì„ íƒì…ë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
        sys.exit(1)
    
    # ğŸš© íŒŒì´ì¬ ë²„ì „ë³„ API/ì´ë©”ì¼ ë´‡/ëŒ€ì‹œë³´ë“œ í™œì„±í™” í”Œë˜ê·¸
    is_dashboard_enabled = (version_choice == 1)
    is_flask_api_enabled = (version_choice == 1 or version_choice == 2 or version_choice == 3) # V1, V2ëŠ” Anvil API, V3ëŠ” Flask API (ì—¬ê¸°ì„œ ë¹Œë“œ)
    is_email_bot_enabled = (version_choice == 1)
    is_pure_bot_mode = (version_choice == 4)

    return bot_name, currency_name, bot_runtime_choice, version_choice, is_dashboard_enabled, is_flask_api_enabled, is_email_bot_enabled, is_pure_bot_mode

# --- 2.0. .env íŒŒì¼ í…œí”Œë¦¿ ---
def get_env_content(bot_name, currency_name, is_dashboard_enabled, is_flask_api_enabled, is_email_bot_enabled, is_pure_bot_mode):
    env_content = f"""
# .env íŒŒì¼ - {bot_name} í”„ë¡œì íŠ¸ í™˜ê²½ ì„¤ì •

# ë´‡ í† í° (í•„ìˆ˜)
BOT_TOKEN="YOUR_DISCORD_BOT_TOKEN_HERE"

# --- ì›¹ ëŒ€ì‹œë³´ë“œ ê´€ë¦¬ì ê³„ì • (V1ë§Œ ì‚¬ìš©) ---
{"DASHBOARD_ADMIN_USERNAME='sejungim39'" if is_dashboard_enabled else "# DASHBOARD_ADMIN_USERNAME='sejungim39'"}
{"DASHBOARD_ADMIN_PASSWORD='Ty822pzh9kd5uSeC'" if is_dashboard_enabled else "# DASHBOARD_ADMIN_PASSWORD='Ty822pzh9kd5uSeC'"}

# --- API ì„œë²„ URL ì„¤ì • (V1, V2, V3 ì‚¬ìš©) ---
# ğŸš© ì¤‘ìš”: ë²„ì „ë³„ë¡œ ì´ ê°’ì˜ ì—­í• ì´ ë‹¬ë¼ì§‘ë‹ˆë‹¤!
# V1, V2 (Anvil API): Anvil ì•±ì„ ì›¹ì— ë°œí–‰(Publish)í•œ í›„, App Accessì˜ "HTTPS API endpoint URL" (ì˜ˆ: https://your-app-name.anvil.app/_/api/)
# V3 (Flask API): Wispbyteê°€ í• ë‹¹í•œ Flask API ì£¼ì†Œ (ì˜ˆ: http://luna.wisp.uno:8080)
# V4 (API ì—†ìŒ): ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (FLASK_BACKEND_URL=""ë¡œ ë¹„ì›Œë‘ì„¸ìš”)
{"FLASK_BACKEND_URL='YOUR_API_SERVER_URL_HERE'" if is_flask_api_enabled else "FLASK_BACKEND_URL=''"}

# ğŸš© ì¤‘ìš”: ë´‡ì´ Flask/Anvil APIë¡œ ë°ì´í„° ë³´ë‚¼ ë•Œ ì‚¬ìš©í•˜ëŠ” API í‚¤
{"BOT_API_KEY='YOUR_SUPER_SECRET_BOT_API_KEY_HERE'" if is_flask_api_enabled else "BOT_API_KEY=''"}

# ğŸš© ì›¹ ëŒ€ì‹œë³´ë“œ JWT ë°œê¸‰/ê²€ì¦ìš© ì‹œí¬ë¦¿ í‚¤ (V1ë§Œ ì‚¬ìš©)
{"SECRET_KEY='YOUR_JWT_SECRET_KEY_HERE'" if is_dashboard_enabled else "# SECRET_KEY='YOUR_JWT_SECRET_KEY_HERE'"}

# --- Discord OAuth2 ì„¤ì • (V1ë§Œ ì‚¬ìš©) ---
{"DISCORD_CLIENT_ID='YOUR_DISCORD_CLIENT_ID_HERE'" if is_dashboard_enabled else "# DISCORD_CLIENT_ID='YOUR_DISCORD_CLIENT_ID_HERE'"}
{"DISCORD_CLIENT_SECRET='YOUR_DISCORD_CLIENT_SECRET_HERE'" if is_dashboard_enabled else "# DISCORD_CLIENT_SECRET='YOUR_DISCORD_CLIENT_SECRET_HERE'"}

# --- MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì • (í˜„ì¬ ì´ ë²„ì „ë“¤ì€ SQLiteë¥¼ ë©”ì¸ìœ¼ë¡œ ì‚¬ìš©í•˜ë©° MySQLì€ í•„ìš”í•˜ì§€ ì•ŠìŒ) ---
# MySQLì„ ì‚¬ìš©í•˜ê³ ì í•  ê²½ìš° ê´€ë ¨ Flask API (V3) ì½”ë“œë¥¼ ìˆ˜ì •í•´ì•¼ í•©ë‹ˆë‹¤.
# # MYSQL_HOST="YOUR_MYSQL_HOST_HERE"
# # MYSQL_USER="YOUR_MYSQL_USERNAME_HERE"
# # MYSQL_PASSWORD="YOUR_MYSQL_PASSWORD_HERE"
# # MYSQL_DB="YOUR_MYSQL_DATABASE_NAME_HERE"

# --- {BOT_NAME} ì´ë©”ì¼ ì§€ì› ì‹œìŠ¤í…œ ì„¤ì • (V1ë§Œ ì‚¬ìš©) ---
{"SUPPORT_EMAIL_ADDRESS='support@your_domain.com'" if is_email_bot_enabled else "# SUPPORT_EMAIL_ADDRESS='support@your_domain.com'"}
{"SUPPORT_EMAIL_PASSWORD='your_email_app_password'" if is_email_bot_enabled else "# SUPPORT_EMAIL_PASSWORD='your_email_app_password'"}

{"IMAP_SERVER='imap.your_domain.com'" if is_email_bot_enabled else "# IMAP_SERVER='imap.your_domain.com'"}
{"IMAP_PORT=993" if is_email_bot_enabled else "# IMAP_PORT=993"}
{"SMTP_SERVER='smtp.your_domain.com'" if is_email_bot_enabled else "# SMTP_SERVER='smtp.your_domain.com'"}
{"SMTP_PORT=587" if is_email_bot_enabled else "# SMTP_PORT=587"}

# --- YouTube Data API v3 ì„¤ì • (V1, V2, V3ë§Œ ì‚¬ìš©) ---
{"YOUTUBE_API_KEY='YOUR_YOUTUBE_API_KEY_HERE'" if is_flask_api_enabled else "YOUTUBE_API_KEY=''"}

# --- ë´‡ ì†Œìœ ì ID (íŠ¹ì • ëª…ë ¹ì–´ ì‚¬ìš© ê¶Œí•œ ë¶€ì—¬ìš©) ---
# ğŸš© ì´ IDë¥¼ í†µí•´ 'ë´‡ ì†Œìœ ì ì „ìš©' ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
BOT_OWNER_ID="YOUR_BOT_OWNER_DISCORD_USER_ID_HERE"

# --- V4 (ìˆœìˆ˜ ë´‡) ì „ìš© ì„¤ì • ---
# V4 ì„ íƒ ì‹œ, ë´‡ì„ íŠ¹ì • ê¸¸ë“œì—ë§Œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œë¥¼ ë™ê¸°í™”í•  ê²½ìš° í•´ë‹¹ ê¸¸ë“œ ID (ì •ìˆ˜í˜•)
TARGET_GUILD_ID=0 # ì˜ˆ: 123456789012345678 (ì •ìˆ˜í˜•)

# --- ğŸš© ë‚´ë¶€ í”Œë˜ê·¸ (ìë™ ìƒì„± - ìˆ˜ë™ ë³€ê²½ ê¸ˆì§€) ---
IS_PURE_BOT_MODE={str(is_pure_bot_mode).lower()}
IS_FLASK_API_ENABLED={str(is_flask_api_enabled).lower()}
IS_EMAIL_BOT_ENABLED={str(is_email_bot_enabled).lower()}
IS_DASHBOARD_ENABLED={str(is_dashboard_enabled).lower()}
"""
    return env_content

# 5.2. requirements.txt (íŒŒì´ì¬ ë´‡ìš©)
def get_python_requirements_content(is_flask_api_enabled):
    requirements_content = f"""
discord.py==2.3.2
python-dotenv==1.0.1
PyNaCl==1.5.0
requests==2.32.3
yt-dlp==2025.6.30
google-api-python-client==2.133.0
python-dateutil==2.8.2

# ğŸš© API ì„œë²„ ì‚¬ìš© ì‹œ (V1, V2, V3) í•„ìš”í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬
"""
    if is_flask_api_enabled: # Flask APIê°€ í™œì„±í™”ëœ ë²„ì „ì—ì„œë§Œ í•„ìš”
        requirements_content += """
Flask==3.1.1
PyJWT==2.8.0
Flask-CORS==4.0.1
mysql-connector-python==8.4.0 # SQLite ëŒ€ì‹  MySQL ì‚¬ìš©í•  ê²½ìš° í•„ìš”
"""
    return requirements_content

# 5.3. JUSTBOT.py (íŒŒì´ì¬ ë´‡ìš© ëŸ°ì²˜ ìŠ¤í¬ë¦½íŠ¸)
def get_justbot_py_content(bot_name):
    return f"""
import subprocess
import time
import os
import sys
from dotenv import load_dotenv

load_dotenv()

# --- ì‹¤í–‰í•  ìŠ¤í¬ë¦½íŠ¸ ê²½ë¡œ (í”„ë¡œì íŠ¸ ë£¨íŠ¸ ê¸°ì¤€) ---
DISCORD_BOT_SCRIPT = "bot.py"
# ğŸš© Flask API ì„œë²„ëŠ” V3ì—ì„œë§Œ ì´ í™˜ê²½ì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤.
FLASK_API_MODULE_PATH = "justbot_api.app"
EMAIL_SUPPORT_SCRIPT = "email_support_bot.py"


# --- ë¡œê·¸ íŒŒì¼ ìƒì„± í´ë” ---
LOG_DIR = "logs"
if not os.path.exists(LOG_DIR):
    os.makedirs(LOG_DIR)

def start_background_process(name, script_path_or_module_name, python_executable="python3.11", is_module=False):
    """
    Python ìŠ¤í¬ë¦½íŠ¸ ë˜ëŠ” ëª¨ë“ˆì„ ë°±ê·¸ë¼ìš´ë“œ í”„ë¡œì„¸ìŠ¤ë¡œ ì‹œì‘í•˜ê³ 
    í‘œì¤€ ì¶œë ¥/ì—ëŸ¬ë¥¼ ì§€ì •ëœ ë¡œê·¸ íŒŒì¼ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸í•©ë‹ˆë‹¤.
    """
    stdout_log_path = os.path.join(LOG_DIR, f"{{name}}_stdout.log")
    stderr_log_path = os.path.join(LOG_DIR, f"{{name}}_stderr.log")

    cmd = []
    if is_module:
        cmd = [python_executable, "-m", script_path_or_module_name]
    else:
        cmd = [python_executable, script_path_or_module_name]

    try:
        process = subprocess.Popen(
            cmd,
            stdout=open(stdout_log_path, "a", buffering=1),
            stderr=open(stderr_log_path, "a", buffering=1),
            text=True,
            bufsize=1,
            cwd=os.path.dirname(os.path.abspath(__file__))
        )
        print(f"ğŸš€ {{name}} ì‹œì‘ ìš”ì²­: PID={{process.pid}}. ë¡œê·¸: {{stdout_log_path}}, {{stderr_log_path}}")
        return process
    except FileNotFoundError:
        print(f"âŒ ì˜¤ë¥˜: '{{python_executable}}' ë˜ëŠ” '{{script_path_or_module_name}}'ì„(ë¥¼) ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
        return None
    except Exception as e:
        print(f"âŒ {{name}} ì‹¤í–‰ ì¤‘ ì˜ˆì™¸ ë°œìƒ: {{e}}")
        return None

if __name__ == '__main__':
    print(f"--- {BOT_NAME} í†µí•© ì„œë¹„ìŠ¤ ì‹¤í–‰ê¸° ì‹œì‘ ---")
    print("âš ï¸ ë´‡, API ì„œë²„, ì´ë©”ì¼ ë´‡ ë“± í•„ìš”í•œ ì„œë¹„ìŠ¤ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ìì„¸í•œ ë¡œê·¸ëŠ” 'logs/' ë””ë ‰í† ë¦¬ì—ì„œ í™•ì¸í•˜ì„¸ìš”.")

    running_processes = {}

    # 1. ë””ìŠ¤ì½”ë“œ ë´‡ ì‹œì‘ (ëª¨ë“  ë²„ì „ì— í•„ìˆ˜)
    discord_bot_process = start_background_process("Discord_Bot", DISCORD_BOT_SCRIPT, is_module=False)
    if discord_bot_process:
        running_processes["Discord_Bot"] = discord_bot_process

    # 2. Flask API ì„œë²„ ì‹œì‘ (V3ì—ì„œë§Œ ì´ í™˜ê²½ì—ì„œ ì‹¤í–‰)
    if os.getenv("IS_FLASK_API_ENABLED") == "true":
        flask_api_process = start_background_process("Flask_API", FLASK_API_MODULE_PATH, is_module=True)
        if flask_api_process:
            running_processes["Flask_API"] = flask_api_process

    # 3. ì´ë©”ì¼ ì§€ì› ë´‡ ì‹œì‘ (V1ë§Œ)
    if os.getenv("IS_EMAIL_BOT_ENABLED") == "true":
        email_bot_process = start_background_process("Email_Support_Bot", EMAIL_SUPPORT_SCRIPT, is_module=False)
        if email_bot_process:
            running_processes["Email_Support_Bot"] = email_bot_process


    if not running_processes:
        print("âŒ ì‹¤í–‰í•  ì„œë¹„ìŠ¤ê°€ ì—†ìŠµë‹ˆë‹¤. ìŠ¤í¬ë¦½íŠ¸ ì¢…ë£Œ.")
        sys.exit(1)

    print(f"\n--- {BOT_NAME} í†µí•© ì„œë¹„ìŠ¤ ì‹œì‘ ìš”ì²­ ì™„ë£Œ ---")
    print("ì´ì œ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ë°±ê·¸ë¼ìš´ë“œì—ì„œ ì‹¤í–‰ë©ë‹ˆë‹¤. ì´ ì‹¤í–‰ê¸° í”„ë¡œì„¸ìŠ¤ëŠ” ê³„ì† ì‹¤í–‰ë©ë‹ˆë‹¤.")
    print("Ctrl+Cë¥¼ ëˆŒëŸ¬ ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì•ˆì „í•˜ê²Œ ì¢…ë£Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")

    try:
        while True:
            for name, proc in list(running_processes.items()):
                if proc.poll() is not None:
                    print(f"ğŸš¨ {{name}} (PID={{proc.pid}})ê°€ ì˜ˆìƒì¹˜ ëª»í•˜ê²Œ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì¢…ë£Œ ì½”ë“œ: {{proc.poll()}}")
                    running_processes.pop(name)

            if not running_processes:
                print("âš ï¸ ê´€ë¦¬ ì¤‘ì¸ ëª¨ë“  ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ì‹¤í–‰ê¸°ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
                break

            time.sleep(10)

    except KeyboardInterrupt:
        print("\\nCtrl+C ê°ì§€. ëª¨ë“  ì„œë¹„ìŠ¤ë¥¼ ì¢…ë£Œí•©ë‹ˆë‹¤.")
    except Exception as e:
        print(f"âŒ ì‹¤í–‰ê¸° ë©”ì¸ ë£¨í”„ì—ì„œ ì˜ˆì™¸ ë°œìƒ: {{e}}")
    finally:
        print("ëª¨ë“  ì„œë¹„ìŠ¤ ì¢…ë£Œ ì¤‘...")
        for name, proc in running_processes.items():
            if proc.poll() is None:
                proc.terminate()
                try:
                    proc.wait(timeout=5)
                    print(f"âœ… {{name}} ì¢…ë£Œ ì™„ë£Œ.")
                except subprocess.TimeoutExpired:
                    proc.kill()
                    print(f"ğŸš¨ {{name}} ê°•ì œ ì¢…ë£Œ (SIGKILL).")
        print(f"ëª¨ë“  {BOT_NAME} ì„œë¹„ìŠ¤ê°€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.")
"""

# 2.4. bot.py (Discord ë´‡ ì½”ì–´)
def get_bot_py_content(bot_name, currency_name):
    return f"""
import discord
from discord.ext import commands, tasks
import os
from dotenv import load_dotenv
import sqlite3
import datetime
import requests # HTTP ìš”ì²­ìš© (APIì™€ í†µì‹ )

from googleapiclient.discovery import build # Youtube API client (V1, V2, V3 ì‚¬ìš©)

from discord import app_commands

load_dotenv()

# --- SQLite ì„¤ì • (ë´‡ ìì²´ ë°ì´í„° ë° ì„¤ì • ê´€ë¦¬) ---
# ğŸš© ëª¨ë“  ë²„ì „ ê³µìš© DB
DB_FILE = "rp_server_data.db"

def get_db_connection():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    return conn

# ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” (ëª¨ë“  ë´‡ì˜ í…Œì´ë¸” ìƒì„±)
def initialize_db():
    conn = sqlite3.connect(DB_FILE)
    cursor = conn.cursor()

    # ê³µí†µ í…Œì´ë¸”: ë´‡ ìƒíƒœ
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bot_status (
            bot_name TEXT PRIMARY KEY,
            last_heartbeat TEXT NOT NULL,
            status TEXT NOT NULL,
            message TEXT NOT NULL,
            guild_count INTEGER NOT NULL
        )
    \"\"\")
    # ê³µí†µ í…Œì´ë¸”: ì„œë²„ë³„ ì„¤ì •
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS server_configs (
            guild_id TEXT PRIMARY KEY,
            guild_name TEXT,
            welcome_message_enabled INTEGER DEFAULT 0,
            welcome_message_text TEXT,
            leave_message_enabled INTEGER DEFAULT 0,
            leave_message_text TEXT,
            log_channel_id TEXT,

            car_registration_tax INTEGER DEFAULT 50000,
            car_forbidden_cars_json TEXT DEFAULT '[\"íƒ±í¬\", \"ì „íˆ¬ê¸°\", \"í•µì ìˆ˜í•¨\", \"ìš°ì£¼ì„ \"]',
            registration_channel_id TEXT,
            car_admin_channel_id TEXT,
            car_admin_role_id TEXT,
            approved_cars_channel_id TEXT,

            bank_loan_enabled INTEGER DEFAULT 1,
            bank_max_loan_amount INTEGER DEFAULT 1000000,
            bank_loan_interest_rate REAL DEFAULT 0.032,
            bank_channel_id TEXT,

            auto_kick_warn_count INTEGER DEFAULT 5,
            mute_role_id TEXT,

            ticket_open_channel_id TEXT,
            ticket_category_id TEXT,
            ticket_staff_role_id TEXT,

            invite_filter_enabled INTEGER DEFAULT 0,
            spam_filter_enabled INTEGER DEFAULT 0,
            spam_threshold INTEGER DEFAULT 5,
            spam_time_window INTEGER DEFAULT 10,

            youtube_activity_enabled INTEGER DEFAULT 0,
            youtube_channel_ids_json TEXT DEFAULT '[]',
            youtube_notification_channel_id TEXT
        )
    \"\"\")
    # ì»¬ëŸ¼ ì¶”ê°€ (try-exceptë¡œ ë³€ê²½)
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN guild_name TEXT")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN invite_filter_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_filter_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_threshold INTEGER DEFAULT 5")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN spam_time_window INTEGER DEFAULT 10")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN bank_channel_id TEXT")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_activity_enabled INTEGER DEFAULT 0")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_channel_ids_json TEXT DEFAULT '[]'")
    except sqlite3.OperationalError: pass
    try:
        cursor.execute("ALTER TABLE server_configs ADD COLUMN youtube_notification_channel_id TEXT")
    except sqlite3.OperationalError: pass

    # ìƒˆë¡œìš´ ê³µí†µ í…Œì´ë¸”: ì„œë²„ë³„ ì»¤ë§¨ë“œ í™œì„±í™”/ë¹„í™œì„±í™” ìƒíƒœ
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS server_command_states (
            guild_id TEXT NOT NULL,
            command_name TEXT NOT NULL,
            is_enabled INTEGER NOT NULL DEFAULT 1,
            PRIMARY KEY (guild_id, command_name)
        )
    \"\"\")
    # ìƒˆë¡œìš´ ê³µí†µ í…Œì´ë¸”: ë´‡ í˜„ì¬ ìƒíƒœ ë° í™œë™ (ë´‡ ì†Œìœ ììš©)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bot_presence_settings (
            id INTEGER PRIMARY KEY DEFAULT 1,
            status TEXT DEFAULT 'online',
            activity_type TEXT DEFAULT 'playing',
            activity_name TEXT DEFAULT 'RP ì„œë²„ ìš´ì˜'
        )
    \"\"\")
    cursor.execute("INSERT OR IGNORE INTO bot_presence_settings (id, status, activity_type, activity_name) VALUES (1, 'online', 'playing', 'RP ì„œë²„ ìš´ì˜')")

    # ì€í–‰ ê³„ì¢Œ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bank_accounts (
            user_id TEXT PRIMARY KEY,
            username TEXT NOT NULL,
            balance INTEGER NOT NULL DEFAULT 0
        )
    \"\"\")
    # ì€í–‰ ê±°ë˜ ë‚´ì—­ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS bank_transactions (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            type TEXT NOT NULL,
            amount INTEGER NOT NULL,
            timestamp TEXT NOT NULL,
            related_user_id TEXT,
            related_username TEXT,
            description TEXT
        )
    \"\"\")
    # ì°¨ëŸ‰ ë“±ë¡ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS car_registrations (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            car_name TEXT NOT NULL,
            registration_tax INTEGER NOT NULL,
            status TEXT NOT NULL,
            requested_at TEXT NOT NULL,
            guild_id TEXT,
            channel_id TEXT,
            approved_by TEXT,
            approved_at TEXT,
            rejected_by TEXT,
            rejected_at TEXT,
            rejection_reason TEXT,
            timed_out_at TEXT
        )
    \"\"\")
    # ì‚¬ìš©ì ê²½ê³  í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS user_warnings (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            reason TEXT NOT NULL,
            moderator_id TEXT NOT NULL,
            moderator_name TEXT NOT NULL,
            timestamp TEXT NOT NULL
        )
    \"\"\")
    # ê²Œì„ í†µê³„ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS game_stats (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            game_type TEXT NOT NULL,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            sides INTEGER,
            result TEXT,
            user_choice TEXT,
            bot_choice TEXT,
            timestamp TEXT NOT NULL
        )
    \"\"\")
    # í‹°ì¼“ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS tickets (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            guild_id TEXT NOT NULL,
            channel_id TEXT NOT NULL,
            status TEXT NOT NULL,
            reason TEXT,
            opened_at TEXT NOT NULL,
            closed_at TEXT,
            closed_by TEXT
        )
    \"\"\")
    # ëŒ€ì¶œ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS loans (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            user_id TEXT NOT NULL,
            username TEXT NOT NULL,
            loan_amount INTEGER NOT NULL,
            interest_rate REAL NOT NULL,
            total_repay_amount INTEGER NOT NULL,
            paid_amount INTEGER NOT NULL DEFAULT 0,
            status TEXT NOT NULL,
            loan_date TEXT NOT NULL,
            due_date TEXT
        )
    \"\"\")
    # ëŒ€ì¶œ ìƒí™˜ ë‚´ì—­ í…Œì´ë¸”
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS loan_payments (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            loan_id INTEGER NOT NULL,
            user_id TEXT NOT NULL,
            payment_amount INTEGER NOT NULL,
            payment_date TEXT NOT NULL,
            FOREIGN KEY (loan_id) REFERENCES loans(id)
        )
    \"\"\")

    # ì•…ì„± ì‚¬ìš©ì ë¸”ë™ë¦¬ìŠ¤íŠ¸ í…Œì´ë¸” (ê°œë…ì ì¸ êµ¬í˜„)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS global_blacklist (
            user_id TEXT PRIMARY KEY,
            username TEXT NOT NULL,
            reason TEXT,
            added_by TEXT,
            added_at TEXT
        )
    \"\"\")
    cursor.execute("INSERT OR IGNORE INTO global_blacklist (user_id, username, reason, added_by, added_at) VALUES ('123456789012345678', 'í…ŒìŠ¤íŠ¸ì•…ì„±ìœ ì €', 'ìë™í™” ë„ë°° ë´‡', 'system', datetime('now'))")
    cursor.execute("INSERT OR IGNORE INTO global_blacklist (user_id, username, reason, added_by, added_at) VALUES ('987654321098765432', 'ê´‘ê³ ìš©ê³„ì •', 'ìŠ¤íŒ¸ ê´‘ê³ ', 'system', datetime('now'))")

    # ğŸš© ë³µêµ¬ ë°ì´í„° í…Œì´ë¸” (SQLite)
    cursor.execute(\"\"\"
        CREATE TABLE IF NOT EXISTS recovery_data (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            guild_id TEXT UNIQUE NOT NULL,
            snapshot_time TEXT NOT NULL,
            channels_json TEXT,
            roles_json TEXT,
            server_info_json TEXT,
            members_roles_json TEXT
        )
    \"\"\")

    conn.commit()
    conn.close()
    print(f"âœ… {BOT_NAME}: SQLite ë°ì´í„°ë² ì´ìŠ¤ '{DB_FILE}' ì´ˆê¸°í™” ì™„ë£Œ!")

# ì„œë²„ë³„ ì„¤ì • ë¶ˆëŸ¬ì˜¤ëŠ” í—¬í¼ í•¨ìˆ˜
def get_server_config(guild_id):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT * FROM server_configs WHERE guild_id = ?", (str(guild_id),))
    config = cursor.fetchone()
    conn.close()
    return config

# ì„œë²„ë³„ ì„¤ì • ì—…ë°ì´íŠ¸/ì‚½ì… í—¬í¼ í•¨ìˆ˜
def set_server_config(guild_id, config_name, config_value):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute(f\"\"\"
        INSERT INTO server_configs (guild_id, {config_name}) VALUES (?, ?)
        ON CONFLICT(guild_id) DO UPDATE SET {config_name} = EXCLUDED.{config_name}
    \"\"\", (str(guild_id), str(config_value)))
    conn.commit()
    conn.close()

# íŠ¹ì • ëª…ë ¹ì–´ì˜ í™œì„±í™” ìƒíƒœë¥¼ í™•ì¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
def is_command_enabled(guild_id: int, command_name: str) -> bool:
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT is_enabled FROM server_command_states WHERE guild_id = ? AND command_name = ?", (str(guild_id), command_name))
    result = cursor.fetchone()
    conn.close()
    return result[0] == 1 if result else True # ê¸°ë³¸ì ìœ¼ë¡œ í™œì„±í™” (ì„¤ì • ì—†ìœ¼ë©´ ì¼œì§„ ìƒíƒœ)

# ëª…ë ¹ì–´ í™œì„±í™” ìƒíƒœë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
def set_command_enabled_state(guild_id: int, command_name: str, is_enabled: bool):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    enabled_val = 1 if is_enabled else 0
    cursor.execute(\"\"\"
        INSERT INTO server_command_states (guild_id, command_name, is_enabled)
        VALUES (?, ?, ?)
        ON CONFLICT(guild_id) DO UPDATE SET is_enabled = EXCLUDED.is_enabled
    \"\"\", (str(guild_id), command_name, enabled_val))
    conn.commit()
    conn.close()

# ë´‡ ìƒíƒœ ë° í™œë™ ì„¤ì • ë¶ˆëŸ¬ì˜¤ê¸°
def get_bot_presence_settings():
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute("SELECT status, activity_type, activity_name FROM bot_presence_settings WHERE id = 1")
    settings = cursor.fetchone()
    conn.close()
    return settings if settings else {'status': 'online', 'activity_type': 'playing', 'activity_name': 'RP ì„œë²„ ìš´ì˜'} # ê¸°ë³¸ê°’

# ë´‡ ìƒíƒœ ë° í™œë™ ì„¤ì • ì—…ë°ì´íŠ¸
def set_bot_presence_settings(status, activity_type, activity_name):
    conn = sqlite3.connect(DB_FILE)
    conn.row_factory = sqlite3.Row
    cursor = conn.cursor()
    cursor.execute(\"\"\"
        INSERT OR REPLACE INTO bot_presence_settings (id, status, activity_type, activity_name)
        VALUES (1, ?, ?, ?)
    \"\"\", (status, activity_type, activity_name))
    conn.commit()
    conn.close()

initialize_db()


intents = discord.Intents.all()
intents.message_content = True # ë©”ì‹œì§€ ë‚´ìš© ì½ê¸° ê¶Œí•œ í™œì„±í™”

# ë´‡ ì ‘ë‘ì‚¬ ë³€ê²½ (opendiscordbot!) # ğŸš© ì´ë¦„ ë³€ê²½
bot = commands.Bot(command_prefix='ì €ìŠ¤íŠ¸ ', intents=intents)

BOT_NAME = "{bot_name}" # ğŸš© ë´‡ ì´ë¦„ ì‚¬ìš©
BOT_TOKEN = os.getenv("BOT_TOKEN")

# Flask API ì„œë²„ URL
FLASK_BACKEND_URL = os.getenv("FLASK_BACKEND_URL")
# Flask API í†µì‹  ë³´ì•ˆ í‚¤ (ë´‡->Flask API)
BOT_API_KEY = os.getenv("BOT_API_KEY")

# YouTube API í‚¤
YOUTUBE_API_KEY = os.getenv("YOUTUBE_API_KEY")

# ë´‡ ì†Œìœ ì ID
BOT_OWNER_ID = int(os.getenv("BOT_OWNER_ID", "0"))

# V4 ìˆœìˆ˜ ë´‡ìš©: ëŒ€ìƒ ê¸¸ë“œ ID
TARGET_GUILD_ID = int(os.getenv("TARGET_GUILD_ID", "0"))

# ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œ í”Œë˜ê·¸ (ìŠ¤í¬ë¦½íŠ¸ê°€ ì„¤ì •)
IS_PURE_BOT_MODE = os.getenv("IS_PURE_BOT_MODE") == "true"


if not FLASK_BACKEND_URL and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ API URL í•„ìˆ˜
    print("âŒ Flask_BACKEND_URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ì—ì„œ APIë¡œ ë°ì´í„° í‘¸ì‹œ ê¸°ëŠ¥ì´ ì œí•œë©ë‹ˆë‹¤.")
if not BOT_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œê°€ ì•„ë‹ ë•Œë§Œ API í‚¤ í•„ìˆ˜
    print("âŒ BOT_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ì—ì„œ APIë¡œ ë°ì´í„° í‘¸ì‹œ ì‹œ ì¸ì¦ì— ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
if not YOUTUBE_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œì—ì„œëŠ” ìœ íŠœë¸Œ API í•„ìš” ì—†ìŒ
    print("âŒ YOUTUBE_API_KEYê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ìœ íŠœë¸Œ í™œë™ ê°ì§€ ê¸°ëŠ¥ì„ ì‚¬ìš©í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
if not BOT_OWNER_ID: # ğŸš© BOT_OWNER_IDë¡œ ë³€ê²½
    print("âš ï¸ BOT_OWNER_IDê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ë´‡ ì†Œìœ ì ì „ìš© ëª…ë ¹ì–´ê°€ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")
if IS_PURE_BOT_MODE and not TARGET_GUILD_ID: # ğŸš© ìˆœìˆ˜ ë´‡ ëª¨ë“œì¼ ë•Œ ê¸¸ë“œ ID í•„ìˆ˜
    print("âŒ ìˆœìˆ˜ ë´‡ ëª¨ë“œëŠ” TARGET_GUILD_IDê°€ í•„ìˆ˜ì…ë‹ˆë‹¤. ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ê°€ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.")


@tasks.loop(minutes=1)
async def record_bot_status():
    status_info = {
        "bot_name": BOT_NAME,
        "last_heartbeat": datetime.datetime.now(datetime.UTC).isoformat(),
        "status": "Online",
        "message": "ì •ìƒ ì‘ë™ ì¤‘",
        "guild_count": len(bot.guilds) if bot.guilds else 0
    }

    # SQLiteì— ë¡œì»¬ë¡œ ì €ì¥ (ê¸°ì¡´ ê¸°ëŠ¥ ìœ ì§€)
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute(\"\"\"
        INSERT OR REPLACE INTO bot_status (bot_name, last_heartbeat, status, message, guild_count)
        VALUES (?, ?, ?, ?, ?)
    \"\"\", (status_info["bot_name"], status_info["last_heartbeat"], status_info["status"], status_info["message"], status_info["guild_count"]))
    conn.commit()
    conn.close()

    # ğŸš© Flask APIë¡œ ë´‡ ìƒíƒœ í‘¸ì‹œ (ìˆœìˆ˜ ë´‡ ëª¨ë“œì—ì„œëŠ” API í˜¸ì¶œ ì•ˆ í•¨)
    if not IS_PURE_BOT_MODE and FLASK_BACKEND_URL:
        try:
            api_endpoint = f"{FLASK_BACKEND_URL}/api/bot_status"
            headers = {
                'Content-Type': "application/json",
                'X-Api-Key': BOT_API_KEY
            }
            response = requests.post(api_endpoint, json=status_info, headers=headers)
            if response.status_code == 200:
                print(f"âœ… ë´‡ ìƒíƒœ ì •ë³´ Flask APIë¡œ ì „ì†¡ ì„±ê³µ: {response.status_code}")
            else:
                print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì „ì†¡ ì‹¤íŒ¨: {response.status_code} - {response.text}")
        except requests.exceptions.ConnectionError as e:
            print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì—°ê²° ì˜¤ë¥˜: {e}")
        except Exception as e:
            print(f"âŒ ë´‡ ìƒíƒœ ì •ë³´ Flask API ì „ì†¡ ì¤‘ ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜: {e}")


@tasks.loop(minutes=5)
async def update_bot_presence():
    settings = get_bot_presence_settings()
    if not settings: return

    status_map = {
        'online': discord.Status.online,
        'idle': discord.Status.idle,
        'dnd': discord.Status.dnd,
        'invisible': discord.Status.invisible
    }
    activity_type_map = {
        'playing': discord.ActivityType.playing,
        'listening': discord.ActivityType.listening,
        'watching': discord.ActivityType.watching,
        'streaming': discord.ActivityType.streaming
    }

    discord_status = status_map.get(settings['status'], discord.Status.online)
    discord_activity_type = activity_type_map.get(settings['activity_type'], discord.ActivityType.playing)

    activity = discord.Activity(type=discord_activity_type, name=settings['activity_name'])

    await bot.change_presence(status=discord_status, activity=activity)
    print(f"âœ… ë´‡ ìƒíƒœ ì—…ë°ì´íŠ¸ ì™„ë£Œ: ìƒíƒœ={settings['status']}, í™œë™={settings['activity_type']} {settings['activity_name']}")


@bot.event
async def on_ready():
    print(f'ğŸš€ {bot.user.name} ë´‡ ì¤€ë¹„ ì™„ë£Œ! ëª¨ë“  ê¸°ëŠ¥ ì•¼ë¬´ì§€ê²Œ ì‹œì‘í•©ë‹ˆë‹¤.')
    try:
        # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì¼ ê²½ìš° íŠ¹ì • ê¸¸ë“œì—ë§Œ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”
        if IS_PURE_BOT_MODE and TARGET_GUILD_ID:
            target_guild_obj = bot.get_guild(TARGET_GUILD_ID)
            if target_guild_obj:
                await bot.tree.sync(guild=target_guild_obj) # íŠ¹ì • ê¸¸ë“œì—ë§Œ ë™ê¸°í™”
                print(f"âœ… ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì™„ë£Œ! (ëŒ€ìƒ ê¸¸ë“œ: {target_guild_obj.name})")
            else:
                print(f"âŒ ëŒ€ìƒ ê¸¸ë“œ ({TARGET_GUILD_ID})ë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.")
        else: # ê·¸ ì™¸ ë²„ì „ì€ ê¸€ë¡œë²Œ ë™ê¸°í™” (V1, V2, V3)
            await bot.tree.sync() # ê¸€ë¡œë²Œ ë™ê¸°í™”
            print(f"âœ… ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì™„ë£Œ! (ê¸€ë¡œë²Œ)")
    except Exception as e:
        print(f"âŒ ìŠ¬ë˜ì‹œ ì»¤ë§¨ë“œ ë™ê¸°í™” ì‹¤íŒ¨: {e}")
    record_bot_status.start()
    update_bot_presence.start()

    # Cogs ë¡œë“œ ì‹œ í•„ìš”í•œ í•¨ìˆ˜ë“¤ì„ bot ê°ì²´ì— ì§ì ‘ í• ë‹¹
    bot.get_server_config = get_server_config
    bot.set_server_config = set_server_config
    bot.get_db_connection = get_db_connection
    bot.is_command_enabled = is_command_enabled
    bot.set_command_enabled_state = set_command_enabled_state
    bot.get_bot_presence_settings = get_bot_presence_settings
    bot.set_bot_presence_settings = set_bot_presence_settings
    bot.FLASK_BACKEND_URL = FLASK_BACKEND_URL
    bot.BOT_API_KEY = BOT_API_KEY
    bot.BOT_OWNER_ID = BOT_OWNER_ID # ğŸš© BOT_OWNER_IDë¡œ ë³€ê²½

    # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì¼ ê²½ìš° Flask API í•¨ìˆ˜ë“¤ì„ Noneìœ¼ë¡œ ì„¤ì •
    if IS_PURE_BOT_MODE:
        bot.send_recovery_snapshot_to_api = None
        bot.get_recovery_snapshot_from_api = None
    else:
        bot.send_recovery_snapshot_to_api = send_recovery_snapshot_to_api
        bot.get_recovery_snapshot_from_api = get_recovery_snapshot_from_api

    if YOUTUBE_API_KEY and not IS_PURE_BOT_MODE: # ğŸš© Pure Bot ëª¨ë“œì—ì„œëŠ” ìœ íŠœë¸Œ API í•„ìš” ì—†ìŒ
        try:
            bot.youtube_service = build('youtube', 'v3', developerKey=YOUTUBE_API_KEY)
            print("âœ… YouTube Data API ì„œë¹„ìŠ¤ ë¹Œë“œ ì™„ë£Œ.")
        except Exception as e:
            print(f"âŒ YouTube Data API ì„œë¹„ìŠ¤ ë¹Œë“œ ì‹¤íŒ¨: {e}")
            bot.youtube_service = None
    else:
        bot.youtube_service = None


    cogs_to_load = [
        "cogs.bank",
        "cogs.car",
        "cogs.moderation",
        "cogs.music",
        "cogs.game",
        "cogs.youtube_tracker"
    ]
    for cog in cogs_to_load:
        # ğŸš© V4 (ìˆœìˆ˜ ë´‡) ëª¨ë“œì—ì„œëŠ” youtube_tracker ë¡œë“œí•˜ì§€ ì•ŠìŒ (API ì„œë²„ ì—†ìœ¼ë¯€ë¡œ)
        if IS_PURE_BOT_MODE and cog == "cogs.youtube_tracker":
            print("âš ï¸ ìˆœìˆ˜ ë´‡ ëª¨ë“œì—ì„œëŠ” youtube_tracker ì½”ê·¸ë¥¼ ë¡œë“œí•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.")
            continue
        try:
            await bot.load_extension(cog)
            print(f"ë¡œë“œ ì„±ê³µ: {cog}")
        except Exception as e:
            print(f"ë¡œë“œ ì‹¤íŒ¨: {cog} - {e}")

    # ë´‡ì´ ì¼œì§ˆ ë•Œ guild_nameì´ ì—†ëŠ” server_configs í•­ëª©ì„ ì±„ì›Œ ë„£ê¸°
    conn = get_db_connection()
    cursor = conn.cursor()
    cursor.execute("SELECT guild_id FROM server_configs WHERE guild_name IS NULL")
    guild_ids_without_name = cursor.fetchall()

    for guild_row in guild_ids_without_name:
        guild_id = int(guild_row['guild_id'])
        guild = bot.get_guild(guild_id)
        if guild:
            cursor.execute("UPDATE server_configs SET guild_name = ? WHERE guild_id = ?", (guild.name, str(guild_id)))
            print(f"âœ… ì„œë²„ ID {guild_id}ì˜ ì´ë¦„ '{guild.name}'ì„(ë¥¼) DBì— ì—…ë°ì´íŠ¸í–ˆìŠµë‹ˆë‹¤.")
        else:
            print(f"âš ï¸ ë´‡ì´ ê¸¸ë“œ {guild_id}ì— ì ‘ê·¼í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸¸ë“œê°€ ì¡´ì¬í•˜ì§€ ì•Šê±°ë‚˜ ë´‡ì´ ì„œë²„ì— ì—†ìŠµë‹ˆë‹¤.")
    conn.commit()
    conn.close()


@bot.event
async def on_message(message):
    if message.author == bot.user or not message.guild:
        return

    await bot.process_commands(message)


@bot.event
async def on_member_join(member: discord.Member):
    """ë©¤ë²„ê°€ ì„œë²„ì— ê°€ì…í•  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤."""
    if member.bot: return
    guild = member.guild
    config = get_server_config(guild.id)

    if config and config.get('welcome_message_enabled', 0):
        channel_id = config.get('log_channel_id')
        if not channel_id: return

        channel = bot.get_channel(int(channel_id))
        if channel:
            message_text = config.get('welcome_message_text', "ì–´ì„œì˜¤ì„¸ìš”, {user}ë‹˜!")
            message_text = message_text.replace("{user}", member.mention)
            message_text = message_text.replace("{server}", guild.name)
            message_text = message_text.replace("{member_count}", str(guild.member_count))
            try:
                await channel.send(message_text)
            except discord.Forbidden:
                print(f"âŒ ì±„ë„ {channel.name}ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")

@bot.event
async def on_member_remove(member: discord.Member):
    """ë©¤ë²„ê°€ ì„œë²„ë¥¼ ë– ë‚  ë•Œ ì‹¤í–‰ë©ë‹ˆë‹¤."""
    if member.bot: return
    guild = member.guild
    config = get_server_config(guild.id)

    if config and config.get('leave_message_enabled', 0):
        channel_id = config.get('log_channel_id')
        if not channel_id: return

        channel = bot.get_channel(int(channel_id))
        if channel:
            message_text = config.get('leave_message_text', "ì•ˆë…•íˆê°€ì„¸ìš”, {user}ë‹˜.")
            message_text = message_text.replace("{user}", member.display_name)
            message_text = message_text.replace("{server}", guild.name)
            message_text = message_text.replace("{member_count}", str(guild.member_count))
            try:
                await channel.send(message_text)
            except discord.Forbidden:
                print(f"âŒ ì±„ë„ {channel.name}ì— ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.")


@bot.event
async def on_interaction(interaction: discord.Interaction):
    if interaction.type == discord.InteractionType.application_command and interaction.guild:
        command_name_parts = [interaction.command.name]
        if interaction.command.parent:
            command_name_parts.insert(0, interaction.command.parent.name)
            if interaction.command.parent.parent:
                command_name_parts.insert(0, interaction.command.parent.parent.name)
        full_command_name = " ".join(command_name_parts)

        if not is_command_enabled(interaction.guild.id, full_command_name):
            await interaction.response.send_message(f"âŒ ì´ ëª…ë ¹ì–´ (`/{full_command_name}`)ëŠ” í˜„ì¬ ì´ ì„œë²„ì—ì„œ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤ã€‚", ephemeral=True)
            return
    
    await bot.process_commands(interaction)


@bot.event
async def on_app_command_error_global(interaction: discord.Interaction, error: app_commands.AppCommandError):
    if interaction.response.is_done():
        print(f"ì˜¤ë¥˜ ë°œìƒ (ì´ë¯¸ ì‘ë‹µ ì „ì†¡ë¨): {error}")
        return

    if isinstance(error, app_commands.CommandInvokeError):
        print(f"ì „ì—­ ì˜¤ë¥˜ ë°œìƒ: {error.original}")
        await interaction.response.send_message(f"ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error.original}", ephemeral=True)

    elif isinstance(error, app_commands.MissingPermissions):
        await interaction.response.send_message("âŒ ì´ ëª…ë ¹ì–´ë¥¼ ì‚¬ìš©í•  ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤. ê´€ë¦¬ì(Administrator) ê¶Œí•œì´ í•„ìš”í•©ë‹ˆë‹¤ã€‚", ephemeral=True)
    elif isinstance(error, app_commands.CommandOnCooldown):
        await interaction.response.send_message(f"âŒ ì´ ëª…ë ¹ì–´ëŠ” ì¿¨íƒ€ì„ ì¤‘ì…ë‹ˆë‹¤. {error.retry_after:.2f}ì´ˆ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”ã€‚", ephemeral=True)
    else:
        print(f"ì•Œ ìˆ˜ ì—†ëŠ” ì „ì—­ ì˜¤ë¥˜: {error}")
        await interaction.response.send_message(f"ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {error}", ephemeral=True)
